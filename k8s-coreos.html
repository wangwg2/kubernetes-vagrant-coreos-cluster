<!DOCTYPE html>
  <html>
    <head>
      <title>k8s-coreos</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///C:\Users\wangw\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.3.2\node_modules\@shd101wyy\mume\dependencies\katex\katex.min.css">
      
      
      
      
      
      
      
      
      

      <style> 
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
html body {
  font-size: 14px;
  /* 等宽字体 */
  /* 非等宽字体 */
}
html body h1,
html body h2,
html body h3,
html body h4,
html body h5,
html body h6 {
  font-family: "Microsoft YaHei", "Courier New", sans-serif;
}
html body pre,
html body code {
  font-family: "Monaco", "Courier New", "Microsoft YaHei", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", sans-serif;
}
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <h2 class="mume-header" id="kubernetes-vagrant-coreos-cluster">kubernetes-vagrant-coreos-cluster</h2>

<p>Kubernetes cluster (for testing purposes) made easy with Vagrant and CoreOS.<br>
<a href="https://github.com/pires/kubernetes-vagrant-coreos-cluster">pires/kubernetes-vagrant-coreos-cluster</a>.<br>
<a href="https://platform9.com/docs/deploy-kubernetes-the-ultimate-guide/">Deploy Kubernetes: The Ultimate Guide</a></p>
<hr>
<h3 class="mume-header" id="%E4%BF%AE%E6%94%B9%E8%AF%B4%E6%98%8E">修改说明</h3>

<h6 class="mume-header" id="update-log">Update Log</h6>

<p>Update 1: 为网路环境修改</p>
<ul>
<li>新增说明文档： <code>k8s-coreos.md</code>、<code>k8s-coreos.html</code></li>
<li>修改 <code>Vagrantfile</code>, 修改 <code>MASTER_CPUS</code> / <code>BASE_IP_ADDR</code> 设置 与 windows 重定向问题.<br>
不使用 <code>plugins/dns/coredns/deploy.sh</code>, 解决 windows 下脚本重定向输出问题</li>
<li><code>setup.tmpl</code> 文件, 修改 “<code>KUB_URL=</code>” 为本地下载地址</li>
<li>以下文件中 “<code>gcr.io/google_containers/hyperkube-amd64</code>” 修改为 “<code>wangwg2/hyperkube-amd64</code>”<br>
<code>master.yaml</code><br>
<code>manifests/master-apiserver-rbac.yaml</code><br>
<code>manifests/master-apiserver.yaml</code><br>
<code>manifests/master-controller-manager.yaml</code><br>
<code>manifests/master-proxy.yaml</code><br>
<code>manifests/master-scheduler.yaml</code><br>
<code>manifests/node-proxy.yaml</code></li>
<li>修改 <code>master.yaml</code>, 解决 <code>gcr.io/google_containers/pause-amd64:3.0</code> 被墙<br>
为 <code>\hyperkube kubelet</code> 增加 <code>--pod-infra-container-image=wangwg2/pause-amd64:3.0 \</code></li>
<li><code>docker logs -f container_name</code> 查看容器日志分析问题。</li>
</ul>
<h6 class="mume-header" id="vagrant-%E8%99%9A%E6%9C%BA%E8%AE%BE%E7%BD%AE">Vagrant 虚机设置</h6>

<p><code>Vagrantfile</code> 文件</p>
<pre class="language-ruby"><span class="token comment" spellcheck="true"># 解决CPU不足</span>
<span class="token constant">MASTER_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'MASTER_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>
<span class="token constant">NODE_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODE_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>
<span class="token comment" spellcheck="true"># IP网络段</span>
<span class="token constant">BASE_IP_ADDR</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'BASE_IP_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"192.168.99"</span>
</pre>
<h6 class="mume-header" id="window-sh-%E9%87%8D%E5%AE%9A%E5%90%91%E9%97%AE%E9%A2%98">Window sh 重定向问题</h6>

<p>修改 <code>Vagrantfile</code>, 不使用 <code>plugins/dns/coredns/deploy.sh</code><br>
<code>Vagrantfile</code></p>
<pre class="language-ruby">  <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
    <span class="token comment" spellcheck="true"># create dns-deployment.yaml file</span>
    dnsFile <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/dns-deployment.yaml"</span>
    <span class="token comment" spellcheck="true"># .....</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
      <span class="token comment" spellcheck="true"># --- 修改前 ---</span>
      system <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/coredns/deploy.sh 10.100.0.10/24 <span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span> <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/coredns/coredns.yaml.sed > <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/coredns-deployment.yaml"</span>
      <span class="token comment" spellcheck="true"># --- 修改后 ---</span>
      system <span class="token string">"cp <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/coredns/coredns.yaml.sed <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/coredns-deployment.yaml"</span>
      system <span class="token string">"sed -i -e s/CLUSTER_DNS_IP/10.100.0.10/g -e s/CLUSTER_DOMAIN/<span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span>/g -e s?SERVICE_CIDR?10.100.0.10\/24?g <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/coredns-deployment.yaml"</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</pre>
<h6 class="mume-header" id="kubectl-%E4%B8%8B%E8%BD%BD%E6%85%A2">kubectl 下载慢</h6>

<p><code>setup.tmpl</code> 文件<br>
解决 <code>bukectl</code>下载慢问题。预先下载到指定目录。<br>
<code>https://storage.googleapis.com/kubernetes-release/release/v${KUBERNETES_VERSION}/bin/linux/amd64/kubectl</code></p>
<p>启动下载服务器：(192.168.99.23)<br>
<code>docker run --name archives-nginx -v /ansible/archives:/usr/share/nginx/html:ro -p 8080:80 -d nginx</code></p>
<p>修改 <code>setup.tmpl</code><br>
<code>KUB_URL=&quot;http://192.168.99.23/kubectl&quot;</code></p>
<h6 class="mume-header" id="docker-registry">Docker Registry</h6>

<p><code>docker run -d -v /data/docker/voldata/registry:/data -p 5000:5000 --restart=always --name registry registry:2</code></p>
<p><code>gcr.io/google_containers/hyperkube-amd64:__RELEASE__</code><br>
<code>wangwg2/hyperkube-amd64:__RELEASE__</code></p>
<h6 class="mume-header" id="docker_options">DOCKER_OPTIONS</h6>

<p><code>Vagrantfile</code> 文件</p>
<pre class="language-ruby"><span class="token constant">DOCKER_OPTIONS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DOCKER_OPTIONS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'--registry-mirror=https://4ue5z1dy.mirror.aliyuncs.com'</span>
</pre>
<h6 class="mume-header" id="masteryml">master.yml</h6>

<p>hyperkube kubelet 会 pull 镜像 <code>gcr.io/google_containers/pause-amd64:3.0</code>。<br>
解决镜像被墙问题，改为 <code>wangwg2/pause-amd64:3.0</code>。<br>
增加 <code>--pod-infra-container-image=wangwg2/pause-amd64:3.0 \</code></p>
<pre class="language-yaml">ExecStart=/usr/bin/docker run \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/<span class="token punctuation">:</span>/rootfs<span class="token punctuation">:</span>ro \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/sys<span class="token punctuation">:</span>/sys<span class="token punctuation">:</span>ro \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/etc/kubernetes<span class="token punctuation">:</span>/etc/kubernetes<span class="token punctuation">:</span>ro \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/var/lib/docker/<span class="token punctuation">:</span>/var/lib/docker<span class="token punctuation">:</span>rw \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/var/lib/kubelet/<span class="token punctuation">:</span>/var/lib/kubelet<span class="token punctuation">:</span>rw \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>volume=/var/run<span class="token punctuation">:</span>/var/run<span class="token punctuation">:</span>rw \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>net=host \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>pid=host \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>privileged=true \
  <span class="token punctuation">-</span><span class="token punctuation">-</span>name=kubelet \
  <span class="token punctuation">-</span>d \
  wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>__RELEASE__ \
    /hyperkube kubelet \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>address=$private_ipv4 \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>network<span class="token punctuation">-</span>plugin= \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>pod<span class="token punctuation">-</span>infra<span class="token punctuation">-</span>container<span class="token punctuation">-</span>image=wangwg2/pause<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>3.0 \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>register<span class="token punctuation">-</span>schedulable=false \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>allow<span class="token punctuation">-</span>privileged=true \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>pod<span class="token punctuation">-</span>manifest<span class="token punctuation">-</span>path=/etc/kubernetes/manifests \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>hostname<span class="token punctuation">-</span>override=$public_ipv4 \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster_dns=10.100.0.10 \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster_domain=__DNS_DOMAIN__ \
    <span class="token punctuation">-</span><span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/master<span class="token punctuation">-</span>kubeconfig.yaml
</pre>
<p>docker run 说明：</p>
<ul>
<li><code>--net</code> 指定容器的网络类型：<code>bridge</code> / <code>host</code> / <code>none</code> / <code>container</code></li>
<li><code>--pid</code> PID 命名空间</li>
<li><code>--privileged</code> 给容器扩展特权</li>
</ul>
<p>kubelet 说明：</p>
<ul>
<li><code>--address</code><br>
kubelet 服务监听的地址 (默认: 0.0.0.0)</li>
<li><code>--pod-infra-container-image</code><br>
基础镜像地址，每个 pod 最先启动的容器，会配置共享的网络<br>
(默认: <a href="http://gcr.io/google_containers/pause-amd64:3.0">gcr.io/google_containers/pause-amd64:3.0</a>)</li>
<li><code>--register-schedulable=false</code></li>
<li><code>--allow-privileged</code><br>
是否允许容器运行在 privileged 模式 (默认:false)</li>
<li><code>--pod-manifest-path</code><br>
本地 manifest 文件的路径或者目录 (默认:&quot;&quot;)</li>
<li><code>--hostname-override</code><br>
指定 hostname，如果非空会使用这个值作为节点在集群中的标识</li>
<li><code>--cluster-dns stringSlice</code><br>
逗号分隔的 DNS 服务器 IP 地址. This value is used for containers DNS server in case of Pods with &quot;dnsPolicy=ClusterFirst&quot;. Note: all DNS servers appearing in the list MUST serve the same set of records otherwise name resolution within the cluster may not work correctly. There is no guarantee as to which DNS server may be contacted for name resolution.</li>
<li><code>--cluster-domain string</code><br>
Domain for this cluster. If set, kubelet will configure all containers to search this domain in addition to the host's search domains</li>
<li><code>--kubeconfig string</code><br>
kubeconfig 文件, 说明如何连接 API server. (默认：&quot;/var/lib/kubelet/kubeconfig&quot;)</li>
</ul>
<hr>
<h3 class="mume-header" id="vagrantfile-%E8%A7%A3%E6%9E%90">Vagrantfile 解析</h3>

<h6 class="mume-header" id="vagrantfile-1">Vagrantfile (1)</h6>

<p>预备 （模块，插件， 定义变量）</p>
<pre class="language-ruby"><span class="token comment" spellcheck="true"># -*- mode: ruby -*-</span>
<span class="token comment" spellcheck="true"># vi: set ft=ruby :</span>

<span class="token keyword">require</span> <span class="token string">'fileutils'</span>
<span class="token keyword">require</span> <span class="token string">'net/http'</span>
<span class="token keyword">require</span> <span class="token string">'open-uri'</span>
<span class="token keyword">require</span> <span class="token string">'json'</span>
<span class="token keyword">require</span> <span class="token string">'date'</span>
<span class="token keyword">require</span> <span class="token string">'pathname'</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span>
  <span class="token keyword">def</span> <span class="token function">redefine_const</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token function">__send__</span><span class="token punctuation">(</span><span class="token symbol">:remove_const</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">if</span> const_defined<span class="token operator">?</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token function">const_set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> <span class="token constant">OS</span>
  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
    <span class="token punctuation">(</span><span class="token operator">/</span>cygwin<span class="token operator">|</span>mswin<span class="token operator">|</span>mingw<span class="token operator">|</span>bccwin<span class="token operator">|</span>wince<span class="token operator">|</span>emx<span class="token operator">/</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token constant">RUBY_PLATFORM</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nil</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>mac<span class="token operator">?</span>
   <span class="token punctuation">(</span><span class="token operator">/</span>darwin<span class="token operator">/</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token constant">RUBY_PLATFORM</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nil</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>unix<span class="token operator">?</span>
    <span class="token operator">!</span><span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>linux<span class="token operator">?</span>
    <span class="token constant">OS</span><span class="token punctuation">.</span>unix<span class="token operator">?</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token constant">OS</span><span class="token punctuation">.</span>mac<span class="token operator">?</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

required_plugins <span class="token operator">=</span> <span class="token string">%w(vagrant-triggers)</span>

<span class="token comment" spellcheck="true"># check either 'http_proxy' or 'HTTP_PROXY' environment variable</span>
enable_proxy <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'http_proxy'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>empty<span class="token operator">?</span>
<span class="token keyword">if</span> enable_proxy
  required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-proxyconf'</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
  required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-winnfsd'</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-timezone'</span><span class="token punctuation">)</span>

required_plugins<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>plugin<span class="token operator">|</span>
  need_restart <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">unless</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span> plugin
    system <span class="token string">"vagrant plugin install <span class="token interpolation"><span class="token delimiter tag">#{</span>plugin<span class="token delimiter tag">}</span></span>"</span>
    need_restart <span class="token operator">=</span> <span class="token keyword">true</span>
  <span class="token keyword">end</span>
  exec <span class="token string">"vagrant <span class="token interpolation"><span class="token delimiter tag">#{</span>ARGV<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token delimiter tag">}</span></span>"</span> <span class="token keyword">if</span> need_restart
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>
<span class="token constant">VAGRANTFILE_API_VERSION</span> <span class="token operator">=</span> <span class="token string">"2"</span>
<span class="token constant">Vagrant</span><span class="token punctuation">.</span>require_version <span class="token string">">= 1.8.6"</span>

<span class="token constant">MASTER_YAML</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"master.yaml"</span><span class="token punctuation">)</span>
<span class="token constant">NODE_YAML</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"node.yaml"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># AUTHORIZATION MODE is a setting for enabling or disabling RBAC for your Kubernetes Cluster</span>
<span class="token comment" spellcheck="true"># The default mode is ABAC.</span>
<span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'AUTHORIZATION_MODE'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'AlwaysAllow'</span>

<span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
  <span class="token constant">CERTS_MASTER_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-master-rbac.sh"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token constant">CERTS_MASTER_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-master.sh"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token constant">CERTS_MASTER_CONF</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/openssl-master.cnf.tmpl"</span><span class="token punctuation">)</span>
<span class="token constant">CERTS_NODE_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-node.sh"</span><span class="token punctuation">)</span>
<span class="token constant">CERTS_NODE_CONF</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/openssl-node.cnf.tmpl"</span><span class="token punctuation">)</span>

<span class="token constant">MANIFESTS_DIR</span> <span class="token operator">=</span> <span class="token constant">Pathname</span><span class="token punctuation">.</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"manifests"</span><span class="token punctuation">)</span>

<span class="token constant">USE_DOCKERCFG</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'USE_DOCKERCFG'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">false</span>
<span class="token constant">DOCKERCFG</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">expand_path</span><span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DOCKERCFG'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"~/.dockercfg"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># DOCKER_OPTIONS = ENV['DOCKER_OPTIONS'] || ''</span>
<span class="token constant">DOCKER_OPTIONS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DOCKER_OPTIONS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'--registry-mirror=https://4ue5z1dy.mirror.aliyuncs.com'</span>


<span class="token constant">KUBERNETES_VERSION</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'KUBERNETES_VERSION'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'1.9.2'</span>

<span class="token constant">CHANNEL</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'CHANNEL'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'alpha'</span>

<span class="token comment" spellcheck="true">#if CHANNEL != 'alpha'</span>
<span class="token comment" spellcheck="true">#  puts "============================================================================="</span>
<span class="token comment" spellcheck="true">#  puts "As this is a fastly evolving technology CoreOS' alpha channel is the only one"</span>
<span class="token comment" spellcheck="true">#  puts "expected to behave reliably. While one can invoke the beta or stable channels"</span>
<span class="token comment" spellcheck="true">#  puts "please be aware that your mileage may vary a whole lot."</span>
<span class="token comment" spellcheck="true">#  puts "So, before submitting a bug, in this project, or upstreams (either kubernetes"</span>
<span class="token comment" spellcheck="true">#  puts "or CoreOS) please make sure it (also) happens in the (default) alpha channel."</span>
<span class="token comment" spellcheck="true">#  puts "============================================================================="</span>
<span class="token comment" spellcheck="true">#end</span>

<span class="token constant">COREOS_VERSION</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'COREOS_VERSION'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'latest'</span>
upstream <span class="token operator">=</span> <span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>.release.core-os.net/amd64-usr/<span class="token interpolation"><span class="token delimiter tag">#{</span>COREOS_VERSION<span class="token delimiter tag">}</span></span>"</span>
<span class="token keyword">if</span> <span class="token constant">COREOS_VERSION</span> <span class="token operator">==</span> <span class="token string">"latest"</span>
  upstream <span class="token operator">=</span> <span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>.release.core-os.net/amd64-usr/current"</span>
  url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/version.txt"</span>
  <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token function">redefine_const</span><span class="token punctuation">(</span><span class="token symbol">:COREOS_VERSION</span><span class="token punctuation">,</span>
    <span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token regex">/COREOS_VERSION=.*/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">'COREOS_VERSION='</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token constant">NODES</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODES'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2</span>

<span class="token constant">MASTER_MEM</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'MASTER_MEM'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1024</span>
<span class="token constant">MASTER_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'MASTER_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>

<span class="token constant">NODE_MEM</span><span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODE_MEM'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2048</span>
<span class="token constant">NODE_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODE_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true"># BASE_IP_ADDR = ENV['BASE_IP_ADDR'] || "172.17.8"</span>
<span class="token constant">BASE_IP_ADDR</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'BASE_IP_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"192.168.99"</span>

<span class="token constant">DNS_PROVIDER</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DNS_PROVIDER'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"coredns"</span>
<span class="token constant">DNS_DOMAIN</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DNS_DOMAIN'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"cluster.local"</span>

<span class="token constant">SERIAL_LOGGING</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'SERIAL_LOGGING'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token constant">GUI</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'GUI'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token constant">USE_KUBE_UI</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'USE_KUBE_UI'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">false</span>

<span class="token constant">BOX_TIMEOUT_COUNT</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'BOX_TIMEOUT_COUNT'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">50</span>

<span class="token keyword">if</span> enable_proxy
  <span class="token constant">HTTP_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'http_proxy'</span><span class="token punctuation">]</span>
  <span class="token constant">HTTPS_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTPS_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'https_proxy'</span><span class="token punctuation">]</span>
  <span class="token constant">NO_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NO_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'no_proxy'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"localhost"</span>
<span class="token keyword">end</span>

<span class="token constant">REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># if this is set true, remember to use --provision when executing vagrant up / reload</span>

<span class="token comment" spellcheck="true"># Read YAML file with mountpoint details</span>
<span class="token constant">MOUNT_POINTS</span> <span class="token operator">=</span> <span class="token constant">YAML</span><span class="token punctuation">:</span><span class="token symbol">:load_file</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"synced_folders.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
<p>说明： ruby模块，插件， 定义变量</p>
<pre class="language-ruby"><span class="token comment" spellcheck="true">## ruby 模块： fileutils net/http ...</span>
<span class="token comment" spellcheck="true">## 插件：vagrant-triggers vagrant-proxyconf vagrant-winnfsd vagrant-timezone</span>
<span class="token comment" spellcheck="true"># def OS.windows</span>
<span class="token comment" spellcheck="true"># MASTER_YAML         = master.yaml</span>
<span class="token comment" spellcheck="true"># NODE_YAML           = node.yaml</span>
<span class="token comment" spellcheck="true"># CERTS_MASTER_SCRIPT = tls/make-certs-master.sh 或 tls/make-certs-master.sh</span>
<span class="token comment" spellcheck="true"># CERTS_MASTER_CONF   = tls/openssl-master.cnf.tmpl</span>
<span class="token comment" spellcheck="true"># CERTS_NODE_SCRIPT   = tls/make-certs-node.sh</span>
<span class="token comment" spellcheck="true"># CERTS_NODE_CONF     = tls/openssl-node.cnf.tmpl</span>
<span class="token comment" spellcheck="true"># DOCKERCFG           = ~/.dockercfg</span>
<span class="token comment" spellcheck="true"># DOCKER_OPTIONS      = </span>
<span class="token comment" spellcheck="true"># KUBERNETES_VERSION  = 1.9.2</span>
<span class="token comment" spellcheck="true"># CHANNEL             = alpha</span>
<span class="token comment" spellcheck="true"># COREOS_VERSION      = latest</span>
<span class="token comment" spellcheck="true"># NODES               = 2</span>
<span class="token comment" spellcheck="true"># MASTER_MEM          = 1024</span>
<span class="token comment" spellcheck="true"># MASTER_CPUS         = 1</span>
<span class="token comment" spellcheck="true"># NODE_MEM            = 2048</span>
<span class="token comment" spellcheck="true"># NODE_CPUS           = 1</span>
<span class="token comment" spellcheck="true"># BASE_IP_ADDR        = 192.168.99</span>
<span class="token comment" spellcheck="true"># DNS_PROVIDER        = coredns</span>
<span class="token comment" spellcheck="true"># DNS_DOMAIN          = cluster.local</span>
<span class="token comment" spellcheck="true"># SERIAL_LOGGING      = false</span>
<span class="token comment" spellcheck="true"># GUI                 = false</span>
<span class="token comment" spellcheck="true"># USE_KUBE_UI         = false</span>
<span class="token comment" spellcheck="true"># BOX_TIMEOUT_COUNT   = 50</span>
<span class="token comment" spellcheck="true"># HTTP_PROXY          = ENV['HTTP_PROXY']</span>
<span class="token comment" spellcheck="true"># HTTPS_PROXY         = ENV['HTTPS_PROXY']</span>
<span class="token comment" spellcheck="true"># NO_PROXY            = "localhost"</span>
<span class="token comment" spellcheck="true"># REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT = false</span>
<span class="token comment" spellcheck="true"># MOUNT_POINTS        = synced_folders.yaml</span>
</pre>
<h6 class="mume-header" id="vagrantfile-2">Vagrantfile (2)</h6>

<p>Vagrant.configure</p>
<pre class="language-ruby"><span class="token constant">Vagrant</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token constant">VAGRANTFILE_API_VERSION</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>
  <span class="token comment" spellcheck="true"># always use host timezone in VMs</span>
  config<span class="token punctuation">.</span>timezone<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token symbol">:host</span>

  <span class="token comment" spellcheck="true"># always use Vagrants' insecure key</span>
  config<span class="token punctuation">.</span>ssh<span class="token punctuation">.</span>insert_key <span class="token operator">=</span> <span class="token keyword">false</span>
  config<span class="token punctuation">.</span>ssh<span class="token punctuation">.</span>forward_agent <span class="token operator">=</span> <span class="token keyword">true</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">"coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_version <span class="token operator">=</span> <span class="token string">"= <span class="token interpolation"><span class="token delimiter tag">#{</span>COREOS_VERSION<span class="token delimiter tag">}</span></span>"</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/coreos_production_vagrant.json"</span>

  <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>vmware<span class="token operator">|</span>
    config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider vmware <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token punctuation">,</span> override<span class="token operator">|</span>
      override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/coreos_production_vagrant_vmware_fusion.json"</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:parallels</span> <span class="token keyword">do</span> <span class="token operator">|</span>vb<span class="token punctuation">,</span> override<span class="token operator">|</span>
    override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">"AntonioMeireles/coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
    override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"https://vagrantcloud.com/AntonioMeireles/coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:virtualbox</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># On VirtualBox, we don't have guest additions or a functional vboxsf</span>
    <span class="token comment" spellcheck="true"># in CoreOS, so tell Vagrant that so it can be smarter.</span>
    v<span class="token punctuation">.</span>check_guest_additions <span class="token operator">=</span> <span class="token keyword">false</span>
    v<span class="token punctuation">.</span>functional_vboxsf     <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:parallels</span> <span class="token keyword">do</span> <span class="token operator">|</span>p<span class="token operator">|</span>
    p<span class="token punctuation">.</span>update_guest_tools <span class="token operator">=</span> <span class="token keyword">false</span>
    p<span class="token punctuation">.</span>check_guest_tools <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># plugin conflict</span>
  <span class="token keyword">if</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">"vagrant-vbguest"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    config<span class="token punctuation">.</span>vbguest<span class="token punctuation">.</span>auto_update <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># setup VM proxy to system proxy environment</span>
  <span class="token keyword">if</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">"vagrant-proxyconf"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> enable_proxy
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token constant">HTTP_PROXY</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>https <span class="token operator">=</span> <span class="token constant">HTTPS_PROXY</span>
    <span class="token comment" spellcheck="true"># most http tools, like wget and curl do not undestand IP range</span>
    <span class="token comment" spellcheck="true"># thus adding each node one by one to no_proxy</span>
    no_proxies <span class="token operator">=</span> <span class="token constant">NO_PROXY</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token constant">NODES</span><span class="token punctuation">.</span>to_i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>i<span class="token operator">|</span>
      vm_ip_addr <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>
      <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token function">redefine_const</span><span class="token punctuation">(</span><span class="token symbol">:NO_PROXY</span><span class="token punctuation">,</span>
        <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>NO_PROXY<span class="token delimiter tag">}</span></span>,<span class="token interpolation"><span class="token delimiter tag">#{</span>vm_ip_addr<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">)</span> <span class="token keyword">unless</span> no_proxies<span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span>vm_ip_addr<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>no_proxy <span class="token operator">=</span> <span class="token constant">NO_PROXY</span>
    <span class="token comment" spellcheck="true"># proxyconf plugin use wrong approach to set Docker proxy for CoreOS</span>
    <span class="token comment" spellcheck="true"># force proxyconf to skip Docker proxy setup</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token punctuation">{</span> docker<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token constant">NODES</span><span class="token punctuation">.</span>to_i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>i<span class="token operator">|</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span>
      hostname <span class="token operator">=</span> <span class="token string">"master"</span>
      <span class="token constant">ETCD_SEED_CLUSTER</span> <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>hostname<span class="token delimiter tag">}</span></span>=http://<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>:2380"</span>
      cfg <span class="token operator">=</span> <span class="token constant">MASTER_YAML</span>
      memory <span class="token operator">=</span> <span class="token constant">MASTER_MEM</span>
      cpus <span class="token operator">=</span> <span class="token constant">MASTER_CPUS</span>
      <span class="token constant">MASTER_IP</span><span class="token operator">=</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>
    <span class="token keyword">else</span>
      hostname <span class="token operator">=</span> <span class="token string">"node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      cfg <span class="token operator">=</span> <span class="token constant">NODE_YAML</span>
      memory <span class="token operator">=</span> <span class="token constant">NODE_MEM</span>
      cpus <span class="token operator">=</span> <span class="token constant">NODE_CPUS</span>
    <span class="token keyword">end</span>

    config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define vmName <span class="token operator">=</span> hostname <span class="token keyword">do</span> <span class="token operator">|</span>kHost<span class="token operator">|</span>
      <span class="token comment" spellcheck="true"># ######################################################################</span>
      <span class="token comment" spellcheck="true"># ## 核心部分</span>
      <span class="token comment" spellcheck="true"># ######################################################################</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>  
</pre>
<h6 class="mume-header" id="vagrantfile-3">Vagrantfile (3)</h6>

<p>Vagrant.configure - config.vm.define</p>
<pre class="language-ruby">config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define vmName <span class="token operator">=</span> hostname <span class="token keyword">do</span> <span class="token operator">|</span>kHost<span class="token operator">|</span>
  kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>hostname <span class="token operator">=</span> vmName

  <span class="token comment" spellcheck="true"># suspend / resume is hard to be properly supported because we have no way</span>
  <span class="token comment" spellcheck="true"># to assure the fully deterministic behavior of whatever is inside the VMs</span>
  <span class="token comment" spellcheck="true"># when faced with XXL clock gaps... so we just disable this functionality.</span>
  kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>reject <span class="token punctuation">[</span><span class="token symbol">:suspend</span><span class="token punctuation">,</span> <span class="token symbol">:resume</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
    info <span class="token string">"'vagrant suspend' and 'vagrant resume' are disabled."</span>
    info <span class="token string">"- please do use 'vagrant halt' and 'vagrant up' instead."</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>instead_of <span class="token symbol">:reload</span> <span class="token keyword">do</span>
    exec <span class="token string">"vagrant halt &amp;&amp; vagrant up"</span>
    exit
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># vagrant-triggers has no concept of global triggers so to avoid having</span>
  <span class="token comment" spellcheck="true"># then to run as many times as the total number of VMs we only call them</span>
  <span class="token comment" spellcheck="true"># in the master (re: emyl/vagrant-triggers#13)...</span>
  <span class="token comment" spellcheck="true"># ## master 虚拟机</span>
  <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
    <span class="token comment" spellcheck="true"># ## trigger.before [:up, :provision]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:provision</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: setting up Kubernetes master..."</span>
      info <span class="token string">"Setting Kubernetes version <span class="token interpolation"><span class="token delimiter tag">#{</span>KUBERNETES_VERSION<span class="token delimiter tag">}</span></span>"</span>

      <span class="token comment" spellcheck="true"># create setup file</span>
      setupFile <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/setup"</span>
      <span class="token comment" spellcheck="true"># ## create temp/setup </span>

      <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
        <span class="token comment" spellcheck="true"># ## create dns-deployment.yaml file</span>
        <span class="token comment" spellcheck="true"># ## 根据 /plugins/dns/kube-dns/dns-deployment-rbac.yaml.tmpl</span>
        <span class="token comment" spellcheck="true"># ##   或 /plugins/dns/kube-dns/dns-deployment.yaml.tmpl</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dns/coredns/coredns.yaml.sed 到 temp/coredns-deployment.yaml</span>
        <span class="token comment" spellcheck="true"># ## 编辑 temp/coredns-deployment.yaml, 替换变量值</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true"># ## trigger.after [:up, :resume]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:resume</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      <span class="token keyword">unless</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
        <span class="token comment" spellcheck="true"># ## 运行 ssh-add ~/.vagrant.d/insecure_private_key</span>
        <span class="token comment" spellcheck="true"># ## 运行 rm -rf ~/.fleetctl/known_hosts</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true"># ## trigger.after [:up]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      info <span class="token string">"Waiting for Kubernetes master to become ready..."</span>
      <span class="token comment" spellcheck="true"># ## 等待 Kubernetes master 就绪</span>

      info <span class="token string">"Installing kubectl for the Kubernetes version we just bootstrapped..."</span>
      <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
        <span class="token comment" spellcheck="true"># ## 运行 sudo -u core /bin/sh /home/core/kubectlsetup install</span>
      <span class="token keyword">else</span>
        <span class="token comment" spellcheck="true"># ## 运行 ./temp/setup install</span>
      <span class="token keyword">end</span>

      <span class="token comment" spellcheck="true"># set cluster</span>
      <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
        <span class="token comment" spellcheck="true"># ## 运行</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl config set-cluster default-cluster --server=https://#{MASTER_IP} --certificate-authority=/vagrant/artifacts/tls/ca.pem</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl config set-credentials default-admin --certificate-authority=/vagrant/artifacts/tls/ca.pem --client-key=/vagrant/artifacts/tls/admin-key.pem --client-certificate=/vagrant/artifacts/tls/admin.pem</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl config set-context local --cluster=default-cluster --user=default-admin</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl config use-context local</span>
      <span class="token keyword">else</span>
        <span class="token comment" spellcheck="true"># ## 运行</span>
        <span class="token comment" spellcheck="true"># ## kubectl config set-cluster default-cluster --server=https://#{MASTER_IP} --certificate-authority=artifacts/tls/ca.pem</span>
        <span class="token comment" spellcheck="true"># ## kubectl config set-credentials default-admin --certificate-authority=artifacts/tls/ca.pem --client-key=artifacts/tls/admin-key.pem --client-certificate=artifacts/tls/admin.pem</span>
        <span class="token comment" spellcheck="true"># ## kubectl config set-context local --cluster=default-cluster --user=default-admin</span>
        <span class="token comment" spellcheck="true"># ## kubectl config use-context local</span>
      <span class="token keyword">end</span>

      info <span class="token string">"Configuring Kubernetes DNS..."</span>
      <span class="token comment" spellcheck="true"># ## 配置 Kubernetes DNS</span>
      <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
        <span class="token comment" spellcheck="true"># ## 运行 </span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/dns-deployment.yaml</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/dns-configmap.yaml</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/dns-service.yaml</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
        <span class="token comment" spellcheck="true"># ## 运行 </span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/coredns-deployment.yaml</span>
      <span class="token keyword">end</span>

      <span class="token keyword">if</span> <span class="token constant">USE_KUBE_UI</span>
        info <span class="token string">"Configuring Kubernetes dashboard..."</span>
        <span class="token comment" spellcheck="true"># ## 配置 Kubernetes dashboard</span>
        <span class="token comment" spellcheck="true"># ## 运行 </span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/dashboard-deployment.yaml</span>
        <span class="token comment" spellcheck="true"># ## /opt/bin/kubectl create -f /home/core/dashboard-service.yaml</span>
        info <span class="token string">"Kubernetes dashboard will be available at http://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>:8080/ui"</span>
      <span class="token keyword">end</span>

    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true"># copy setup files to master vm if host is windows</span>
    <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
      <span class="token comment" spellcheck="true"># ## 拷贝 temp/setup 到 /home/core/kubectlsetup</span>

      <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dns/kube-dns/dns-configmap.yaml 到 /home/core/dns-configmap.yaml</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 temp/dns-deployment.yaml 到 /home/core/dns-deployment.yaml</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dns/kube-dns/dns-service.yaml 到 /home/core/dns-service.yaml</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dns/kube-dns/dns-service-rbac.yaml 到 /home/core/dns-service-rbac.yaml</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 temp/coredns-deployment.yaml 到 /home/core/coredns-deployment.yaml</span>
      <span class="token keyword">end</span>

      <span class="token keyword">if</span> <span class="token constant">USE_KUBE_UI</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dashboard/dashboard-deployment.yaml 到 /home/core/dashboard-deployment.yaml</span>
        <span class="token comment" spellcheck="true"># ## 拷贝 plugins/dashboard/dashboard-service.yaml 到 /home/core/dashboard-service.yaml</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true"># clean temp directory after master is destroyed</span>
    <span class="token comment" spellcheck="true"># ## trigger.after [:destroy]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:destroy</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      <span class="token comment" spellcheck="true"># ## 清理 宿主机 temp/* 和 artifacts/tls/*</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># ## node 虚拟机</span>
  <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># ## trigger.before [:up, :provision]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:provision</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: setting up node..."</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true"># ## trigger.after [:up]</span>
    kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
      info <span class="token string">"Waiting for Kubernetes minion [node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] to become ready..."</span>
      <span class="token comment" spellcheck="true"># ## 等待 node 虚拟机准备好</span>
      <span class="token keyword">if</span> hasResponse
        info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: successfully deployed <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span>"</span>
      <span class="token keyword">else</span>
        info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: failed to deploy <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span> within timeout count of <span class="token interpolation"><span class="token delimiter tag">#{</span>BOX_TIMEOUT_COUNT<span class="token delimiter tag">}</span></span>"</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:halt</span><span class="token punctuation">,</span> <span class="token symbol">:reload</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
    <span class="token comment" spellcheck="true"># ## 清除 /var/lib/coreos-vagrant/vagrantfile-user-data</span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token constant">SERIAL_LOGGING</span>
    <span class="token comment" spellcheck="true"># ## 虚拟机 serial log 设置</span>
  <span class="token keyword">end</span>

  <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">,</span> <span class="token string">"virtualbox"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># ## set gui = GUI</span>
  <span class="token keyword">end</span>
  <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># ## set vm vmx["memsize"], vmx["numvcpus"], vmx['virtualHW.version']</span>
  <span class="token keyword">end</span>
  <span class="token punctuation">[</span><span class="token string">"parallels"</span><span class="token punctuation">,</span> <span class="token string">"virtualbox"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># ## set vm memory, cpus</span>
  <span class="token keyword">end</span>

  kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>network <span class="token symbol">:private_network</span><span class="token punctuation">,</span> ip<span class="token punctuation">:</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>

  <span class="token comment" spellcheck="true"># you can override this in synced_folders.yaml</span>
  kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>synced_folder <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"/vagrant"</span><span class="token punctuation">,</span> disabled<span class="token punctuation">:</span> <span class="token keyword">true</span>

  <span class="token keyword">begin</span>
    <span class="token constant">MOUNT_POINTS</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>mount<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># ## mount 文件系统</span>
    <span class="token keyword">end</span>
  <span class="token keyword">rescue</span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token constant">USE_DOCKERCFG</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span><span class="token constant">DOCKERCFG</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># ## 拷贝 DOCKERCFG 到 /home/core/.dockercfg</span>
    <span class="token comment" spellcheck="true"># ## 拷贝 /home/core/.dockercfg 到 /root/.dockercfg</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># Copy TLS stuff</span>
  <span class="token comment" spellcheck="true"># ## [provision] 处理 TLS </span>
  <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
    <span class="token comment" spellcheck="true"># 拷贝 tls/make-certs-master-rbac.sh 到 /tmp/make-certs.sh</span>
    <span class="token comment" spellcheck="true"># 拷贝 tls/openssl-master.cnf.tmpl 到 /tmp/openssl.cnf</span>
    <span class="token comment" spellcheck="true"># 处理 /tmp/openssl.cnf， 替换变量值</span>
    <span class="token comment" spellcheck="true"># 拷贝 /vagrant/tls/master-kubeconfig.yaml 到 /etc/kubernetes/master-kubeconfig.yaml</span>
  <span class="token keyword">else</span>
    <span class="token comment" spellcheck="true"># 拷贝 tls/make-certs-node.sh 到 /tmp/make-certs.sh</span>
    <span class="token comment" spellcheck="true"># 拷贝 tls/openssl-node.cnf.tmpl 到 /tmp/openssl.cnf</span>
    <span class="token comment" spellcheck="true"># 拷贝 /vagrant/tls/node-kubeconfig.yaml 到 /etc/kubernetes/node-kubeconfig.yaml</span>
    <span class="token comment" spellcheck="true"># 处理 /tmp/openssl.cnf， 替换变量值</span>
    <span class="token comment" spellcheck="true"># 处理 /etc/kubernetes/node-kubeconfig.yaml， 替换变量值</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># Process Kubernetes manifests, depending on node type</span>
  <span class="token comment" spellcheck="true"># ## [provision] 处理 Kubernetes manifests</span>
  <span class="token keyword">begin</span>
    <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
      <span class="token comment" spellcheck="true"># ## 拷贝 /vagrant/manifests/master* 到 /etc/kubernetes/manifests </span>
    <span class="token keyword">else</span>
      <span class="token comment" spellcheck="true"># ## 拷贝 /vagrant/manifests/node* 到 /etc/kubernetes/manifests </span>
    <span class="token keyword">end</span>
    <span class="token comment" spellcheck="true"># ## 处理 /vagrant/manifests/*， 替换变量值</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># Process vagrantfile</span>
  <span class="token comment" spellcheck="true"># ## [provision] Process vagrantfile</span>
  <span class="token keyword">if</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># ## cfg 为 master.yaml 或 node.yml</span>
    <span class="token comment" spellcheck="true"># ## cfg 拷贝到 /tmp/vagrantfile-user-data</span>
    <span class="token comment" spellcheck="true"># ## 处理 /tmp/vagrantfile-user-data， 替换变量值</span>
    <span class="token comment" spellcheck="true"># ## 将 /tmp/vagrantfile-user-data 拷贝到 /var/lib/coreos-vagrant/vagrantfile-user-data</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span>

</pre>
<h6 class="mume-header" id="%E5%88%86%E9%98%B6%E6%AE%B5%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5">分阶段文件检查</h6>

<ol>
<li>before [:up, :provision]<br>
<code>temp/setup</code> (from <code>setup.tmpl</code>)<br>
<code>temp/coredns-deployment.yaml</code> (from <code>plugins/dns/coredns.yaml.sed</code>)</li>
<li>provision (create setup / dns file)<br>
(src：<code>setup.tmpl</code> -&gt; <code>temp/setup</code> -&gt; <code>/home/core/kubectlsetup</code>)<br>
[Coredns]<br>
<code>/home/core/coredns-deployment.yaml</code> (from <code>temp/coredns-deployment.yaml</code>)<br>
[kube-dns]<br>
<code>/home/core/dns-configmap.yaml</code> (from <code>plugins/dns/kube-dns/dns-configmap.yaml</code>)<br>
<code>/home/core/dns-deployment.yaml</code> (from <code>temp/dns-deployment.yaml</code>)<br>
<code>/home/core/dns-service.yaml</code> (from <code>plugins/dns/kube-dns/dns-service.yaml</code>)<br>
<code>/home/core/dns-service-rbac.yaml</code> (from <code>plugins/dns/kube-dns/dns-service-rbac.yaml</code>)<br>
[USE_KUBE_UI]<br>
<code>/home/core/dashboard-deployment.yaml</code> (from <code>plugins/dashboard/dashboard-deployment.yaml</code>)<br>
<code>/home/core/dashboard-service.yaml</code> (from <code>plugins/dashboard/dashboard-service.yaml</code>)</li>
<li>provision (Copy TLS stuff)<br>
<code>/tmp/make-certs.sh</code> (from <code>tls/make-certs-master.sh</code>)<br>
<code>/tmp/openssl.cnf</code> (from <code>openssl-master.cnf.tmpl</code>)<br>
<code>/etc/kubernetes/master-kubeconfig.yaml</code> (from <code>tls/master-kubeconfig.yaml</code>)</li>
<li>Process Kubernetes manifests, depending on node type<br>
Master<br>
<code>/etc/kubernetes/manifests/master-apiserver-rbac.yaml</code><br>
<code>/etc/kubernetes/manifests/master-apiserver.yaml</code><br>
<code>/etc/kubernetes/manifests/master-controller-manager.yaml</code><br>
<code>/etc/kubernetes/manifests/master-proxy.yaml</code><br>
<code>/etc/kubernetes/manifests/master-scheduler.yaml</code><br>
Node<br>
<code>/etc/kubernetes/manifests/node-proxy.yaml</code></li>
<li>provision (Process vagrantfile)<br>
<code>/var/lib/coreos-vagrant/vagrantfile-user-data</code><br>
Master: (src <code>master.yaml</code> -&gt; <code>/var/lib/coreos-vagrant/vagrantfile-user-data</code>)<br>
node: (src <code>node.yaml</code> -&gt; <code>/var/lib/coreos-vagrant/vagrantfile-user-data</code>)</li>
<li>after [:up, :resume]<br>
<code>/home/core/kubectlsetup install</code></li>
</ol>
<hr>
<h6 class="mume-header" id="vagrantfile-user-data">vagrantfile-user-data</h6>

<p>文件结构</p>
<pre class="language-yaml"><span class="token comment" spellcheck="true">#cloud-config</span>
<span class="token punctuation">---</span>
write<span class="token punctuation">-</span>files
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/conf.d/nfs …
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/bin/wupiao …
<span class="token key atrule">coreos</span><span class="token punctuation">:</span>
  <span class="token key atrule">flannel</span><span class="token punctuation">:</span>
    <span class="token key atrule">interface</span><span class="token punctuation">:</span> $public_ipv4
  <span class="token key atrule">units</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpcbind.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpc<span class="token punctuation">-</span>statd.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>member.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flanneld.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> early<span class="token punctuation">-</span>docker.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>certs.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>download.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>import.service <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>kubelet.service <span class="token punctuation">...</span>
  <span class="token key atrule">update</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> alpha
    <span class="token key atrule">reboot-strategy</span><span class="token punctuation">:</span> off
</pre>
<ul>
<li><code>rpcbind.service</code>  {enable: true, command: start }<br>
[active] [running]</li>
<li><code>rpc-statd.service</code> {enable: true, command: start }<br>
[active] [running]</li>
<li><code>etcd-member.service</code> {Type=notify, Restart=always ExecStart=...}<br>
[active] [running]</li>
<li><code>flanneld.service</code> { command: start }<br>
[active] [running]</li>
<li><code>docker.service</code> { command: start }<br>
[active] [running]</li>
<li><code>early-docker.service</code><br>
[--]</li>
<li><code>kube-certs.service</code><br>
{ <code>command: start ExecStart=/tmp/make-certs.sh Type=oneshot RemainAfterExit=true</code> }<br>
[active] [dead]</li>
<li><code>hyperkube-download.service</code> { Type=oneshot RemainAfterExit=true }<br>
<code>ExecStart=/usr/bin/docker pull gcr.io/google_containers/hyperkube-amd64:v1.9.2</code><br>
<code>ExecStart=/usr/bin/docker save --output /vagrant/artifacts/hyperkube_v1.9.2.tar gcr.io/google_containers/hyperkube-amd64:v1.9.2</code><br>
[active] [exited]</li>
<li><code>hyperkube-import.service</code> { command: start Type=oneshot RemainAfterExit=true }<br>
<code>ExecStart=/usr/bin/docker load --input /vagrant/artifacts/hyperkube_v1.9.2.tar</code><br>
[inactive] [dead]</li>
<li><code>kube-kubelet.service</code> { command: start Restart=on-failure ExecStart=...}<br>
[inactive] [dead]</li>
</ul>
<p>master.yaml(vagrantfile-user-data)</p>
<pre class="language-">rpcbind.service              loaded active running RPC Bind
rpc-statd.service            loaded active running NFS status monitor for NFSv2/3 locking.
etcd-member.service          loaded active running etcd
flanneld.service             loaded active running flannel - Network fabric for containers (System Application Container)
docker.service               loaded active running Docker Application Container Engine
early-docker.service
kube-certs.service
hyperkube-download.service   loaded active exited  Download Hyperkube Docker image
hyperkube-import.service
kube-kubelet.service
</pre>
<h6 class="mume-header" id="after-up-resume">after [:up, :resume]</h6>

<pre class="language-ruby">kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
  info <span class="token string">"Waiting for Kubernetes master to become ready..."</span>
  j<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">URI</span><span class="token punctuation">(</span><span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>:8080"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nil</span>
  loop <span class="token keyword">do</span>
    j <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">begin</span>
      res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
    <span class="token keyword">rescue</span>
      sleep <span class="token number">10</span>
    <span class="token keyword">end</span>
    <span class="token keyword">break</span> <span class="token keyword">if</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span> <span class="token keyword">or</span> j <span class="token operator">>=</span> <span class="token constant">BOX_TIMEOUT_COUNT</span>
  <span class="token keyword">end</span>
  <span class="token keyword">if</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
    info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: successfully deployed <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span>"</span>
  <span class="token keyword">else</span>
    info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: failed to deploy <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span> within timeout count of <span class="token interpolation"><span class="token delimiter tag">#{</span>BOX_TIMEOUT_COUNT<span class="token delimiter tag">}</span></span>"</span>
  <span class="token keyword">end</span>

  info <span class="token string">"Installing kubectl for the Kubernetes version we just bootstrapped..."</span>
  <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
    run_remote <span class="token string">"sudo -u core /bin/sh /home/core/kubectlsetup install"</span>
  <span class="token keyword">else</span>
    system <span class="token string">"./temp/setup install"</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># set cluster</span>
  <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
    run_remote <span class="token string">"/opt/bin/kubectl config set-cluster default-cluster --server=https://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span> --certificate-authority=/vagrant/artifacts/tls/ca.pem"</span>
    run_remote <span class="token string">"/opt/bin/kubectl config set-credentials default-admin --certificate-authority=/vagrant/artifacts/tls/ca.pem --client-key=/vagrant/artifacts/tls/admin-key.pem --client-certificate=/vagrant/artifacts/tls/admin.pem"</span>
    run_remote <span class="token string">"/opt/bin/kubectl config set-context local --cluster=default-cluster --user=default-admin"</span>
    run_remote <span class="token string">"/opt/bin/kubectl config use-context local"</span>
  <span class="token keyword">else</span>
    system <span class="token string">"kubectl config set-cluster default-cluster --server=https://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span> --certificate-authority=artifacts/tls/ca.pem"</span>
    system <span class="token string">"kubectl config set-credentials default-admin --certificate-authority=artifacts/tls/ca.pem --client-key=artifacts/tls/admin-key.pem --client-certificate=artifacts/tls/admin.pem"</span>
    system <span class="token string">"kubectl config set-context local --cluster=default-cluster --user=default-admin"</span>
    system <span class="token string">"kubectl config use-context local"</span>
  <span class="token keyword">end</span>

  info <span class="token string">"Configuring Kubernetes DNS..."</span>

  <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
      res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/replicationcontrollers/kube-dns'</span>
      <span class="token keyword">begin</span>
        res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
      <span class="token keyword">rescue</span>
      <span class="token keyword">end</span>
      <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
        <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
          run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-deployment.yaml"</span>
        <span class="token keyword">else</span>
          system <span class="token string">"kubectl create -f temp/dns-deployment.yaml"</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/services/kube-dns'</span>
      <span class="token keyword">begin</span>
        res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
      <span class="token keyword">rescue</span>
      <span class="token keyword">end</span>
      <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
        <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
          run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-configmap.yaml"</span>
          run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-service.yaml"</span>
        <span class="token keyword">else</span>
          system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-configmap.yaml"</span>
          <span class="token comment" spellcheck="true"># Use service file specific to RBAC</span>
          <span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
            system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-service-rbac.yaml"</span>
          <span class="token keyword">else</span>
            system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-service.yaml"</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
          res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/deployment/coredns'</span>
          <span class="token keyword">begin</span>
            res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
          <span class="token keyword">rescue</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
            <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
              run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/coredns-deployment.yaml"</span>
            <span class="token keyword">else</span>
              system <span class="token string">"kubectl create -f temp/coredns-deployment.yaml"</span>
            <span class="token keyword">end</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token keyword">if</span> <span class="token constant">USE_KUBE_UI</span>
    info <span class="token string">"Configuring Kubernetes dashboard..."</span>

    res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/replicationcontrollers/kubernetes-dashboard'</span>
    <span class="token keyword">begin</span>
      res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
    <span class="token keyword">rescue</span>
    <span class="token keyword">end</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
      <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
        run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dashboard-deployment.yaml"</span>
      <span class="token keyword">else</span>
        system <span class="token string">"kubectl create -f plugins/dashboard/dashboard-deployment.yaml"</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/services/kubernetes-dashboard'</span>
    <span class="token keyword">begin</span>
      res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
    <span class="token keyword">rescue</span>
    <span class="token keyword">end</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
      <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
        run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dashboard-service.yaml"</span>
      <span class="token keyword">else</span>
        system <span class="token string">"kubectl create -f plugins/dashboard/dashboard-service.yaml"</span>
      <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    info <span class="token string">"Kubernetes dashboard will be available at http://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>:8080/ui"</span>
  <span class="token keyword">end</span>

<span class="token keyword">end</span>
</pre>
<p>trigger.after [:up]</p>
<pre class="language-bash"><span class="token comment" spellcheck="true"># Installing kubectl for the Kubernetes version we just bootstrapped</span>
<span class="token function">sudo</span> -u core /bin/sh /home/core/kubectlsetup <span class="token function">install</span>
<span class="token comment" spellcheck="true"># set cluster</span>
/opt/bin/kubectl config set-cluster default-cluster --server<span class="token operator">=</span>https://192.168.99.101 --certificate-authority<span class="token operator">=</span>/vagrant/artifacts/tls/ca.pem
/opt/bin/kubectl config set-credentials default-admin --certificate-authority<span class="token operator">=</span>/vagrant/artifacts/tls/ca.pem --client-key<span class="token operator">=</span>/vagrant/artifacts/tls/admin-key.pem --client-certificate<span class="token operator">=</span>/vagrant/artifacts/tls/admin.pem
/opt/bin/kubectl config set-context local --cluster<span class="token operator">=</span>default-cluster --user<span class="token operator">=</span>default-admin
/opt/bin/kubectl config use-context local
<span class="token comment" spellcheck="true"># Configuring Kubernetes DNS...</span>
/opt/bin/kubectl create -f /home/core/coredns-deployment.yaml
</pre>
<hr>
<h3 class="mume-header" id="coreos-file-list">CoreOS File List</h3>

<ul>
<li><code>~/coredns-deployment.yaml</code></li>
<li><code>~/kubectlsetup</code></li>
<li><code>/etc/kubernetes/master-kubeconfig.yaml</code></li>
<li><code>/etc/kubernetes/manifests/master-apiserver-rbac.yaml</code></li>
<li><code>/etc/kubernetes/manifests/master-apiserver.yaml</code></li>
<li><code>/etc/kubernetes/manifests/master-controller-manager.yaml</code></li>
<li><code>/etc/kubernetes/manifests/master-proxy.yaml</code></li>
<li><code>/etc/kubernetes/manifests/master-scheduler.yaml</code></li>
<li><code>/var/lib/coreos-vagrant/vagrantfile-user-data</code></li>
<li><code>/tmp/make-certs.sh</code></li>
<li><code>/tmp/openssl.cnf</code></li>
</ul>
<h6 class="mume-header" id="coredns-deploymentyaml">coredns-deployment.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
      <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> Reconcile
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults
    <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> Reconcile
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>coredns
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">""</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpoints
  <span class="token punctuation">-</span> services
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> namespaces
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults
    <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> EnsureExists
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>coredns
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>coredns
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> EnsureExists
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    .:53 {
        errors
        log
        health
        kubernetes cluster.local 10.100.0.10/24 {
          pods insecure
        }
        prometheus
        proxy . /etc/resolv.conf
        cache 30
    }</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> coredns
    <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> Reconcile
    <span class="token key atrule">kubernetes.io/name</span><span class="token punctuation">:</span> <span class="token string">"CoreDNS"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> coredns
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> coredns
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"CriticalAddonsOnly"</span>
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
        <span class="token key atrule">image</span><span class="token punctuation">:</span> coredns/coredns<span class="token punctuation">:</span>1.0.2
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 170Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 70Mi
        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"-conf"</span><span class="token punctuation">,</span> <span class="token string">"/etc/coredns/Corefile"</span> <span class="token punctuation">]</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/coredns
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">53</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> dns
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">53</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> dns<span class="token punctuation">-</span>tcp
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9153</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> Default
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
            <span class="token key atrule">items</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> Corefile
              <span class="token key atrule">path</span><span class="token punctuation">:</span> Corefile
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> coredns
    <span class="token key atrule">kubernetes.io/cluster-service</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">addonmanager.kubernetes.io/mode</span><span class="token punctuation">:</span> Reconcile
    <span class="token key atrule">kubernetes.io/name</span><span class="token punctuation">:</span> <span class="token string">"CoreDNS"</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> coredns
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.100.0.10
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dns
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">53</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dns<span class="token punctuation">-</span>tcp
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">53</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9153</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
</pre>
<h6 class="mume-header" id="kubectlsetup">kubectlsetup</h6>

<pre class="language-bash {as=&quot;bash&quot;}"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e

PLATFORM<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s <span class="token operator">|</span> <span class="token function">tr</span> '<span class="token punctuation">[</span>:upper:<span class="token punctuation">]</span>' '<span class="token punctuation">[</span>:lower:<span class="token punctuation">]</span>'<span class="token variable">)</span></span>"</span>
KUBERNETES_VERSION<span class="token operator">=</span>1.9.2
<span class="token comment" spellcheck="true"># KUB_URL="https://storage.googleapis.com/kubernetes-release/release/v${KUBERNETES_VERSION}/bin/${PLATFORM}/amd64/kubectl"</span>
KUB_URL<span class="token operator">=</span><span class="token string">"http://192.168.99.23:8080/kubectl"</span>

scream <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cat</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$@</span>"</span> 1<span class="token operator">></span><span class="token operator">&amp;</span>2
    <span class="token keyword">exit</span> 1
<span class="token punctuation">}</span>

<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$PLATFORM</span>"</span> <span class="token keyword">in</span>
  darwin<span class="token operator">|</span>linux<span class="token punctuation">)</span>
    targetDir<span class="token operator">=</span><span class="token string">"/usr/local/bin"</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -r /etc/os-release <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">.</span> /etc/os-release
      <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">=</span> coreos <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        targetDir<span class="token operator">=</span><span class="token string">"/opt/bin"</span>
        unlink <span class="token variable">$HOME</span>/.bash_profile
        <span class="token function">cp</span> /usr/share/skel/.bash_profile <span class="token variable">$HOME</span>/.bash_profile
        <span class="token function">chmod</span> 775 <span class="token variable">$HOME</span>/.bash_profile
      <span class="token keyword">fi</span>
    <span class="token keyword">fi</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span>
    scream <span class="token string">"Unknown or unsupported platform: <span class="token variable">${PLATFORM}</span>"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> -eq 1 <span class="token operator">&amp;&amp;</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">==</span> <span class="token string">"install"</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
  doinstall<span class="token operator">=</span><span class="token string">"true"</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> -x <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    installedversion<span class="token operator">=</span>`<span class="token variable">${targetDir}</span>/kubectl version <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">":"</span> <span class="token string">'{print <span class="token variable">$5</span>}'</span> <span class="token operator">|</span> <span class="token function">head</span> -n1 <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">","</span> <span class="token punctuation">{</span><span class="token string">'print <span class="token variable">$1</span>'</span><span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">"\""</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">"v"</span>`
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$installedversion</span>"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">${KUBERNETES_VERSION}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">echo</span> <span class="token string">"kubectl already installed in version '<span class="token variable">$installedversion</span>'. Skipping install."</span>
      doinstall<span class="token operator">=</span><span class="token string">"false"</span>
    <span class="token keyword">else</span>
      <span class="token keyword">echo</span> <span class="token string">"kubectl installed in version '<span class="token variable">$installedversion</span>' instead of '<span class="token variable">${KUBERNETES_VERSION}</span>'. Reinstalling."</span>
    <span class="token keyword">fi</span>
  <span class="token keyword">fi</span>

  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$doinstall</span>"</span> <span class="token operator">==</span> <span class="token string">"true"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
    <span class="token keyword">echo</span> <span class="token string">"Downloading and installing <span class="token variable">${PLATFORM}</span> version of 'kubectl' v<span class="token variable">${KUBERNETES_VERSION}</span> into <span class="token variable">${targetDir}</span>. This may take a couple minutes, depending on your internet speed.."</span>
    <span class="token punctuation">[</span> -d <span class="token variable">${targetDir}</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">sudo</span> <span class="token function">mkdir</span> -p <span class="token variable">${targetDir}</span>
    <span class="token function">sudo</span> -E curl -s -k -L -o <span class="token variable">${targetDir}</span>/kubectl <span class="token string">"<span class="token variable">${KUB_URL}</span>"</span>
    <span class="token punctuation">[</span> -x <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">sudo</span> <span class="token function">chmod</span> +x <span class="token variable">${targetDir}</span>/kubectl
  <span class="token keyword">fi</span>

  <span class="token comment" spellcheck="true"># use sed to replace current values, if any; create profile file if not exists</span>
  <span class="token function">touch</span> -a <span class="token variable">$HOME</span>/.bash_profile
  <span class="token keyword">echo</span> <span class="token string">"Configuring environment.."</span>
<span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> -eq 1 <span class="token operator">&amp;&amp;</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">==</span> <span class="token string">"uninstall"</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">echo</span> <span class="token string">"Removing 'kubectl' v<span class="token variable">${KUBERNETES_VERSION}</span>.."</span>
  <span class="token punctuation">[</span> -f <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">rm</span> -f <span class="token variable">${targetDir}</span>/kubectl
<span class="token keyword">else</span>
  <span class="token keyword">echo</span> <span class="token string">"Usage: ./setup (install|uninstall)"</span>
<span class="token keyword">fi</span>

</pre>
<h6 class="mume-header" id="master-kubeconfigyaml">master-kubeconfig.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Config
<span class="token key atrule">clusters</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> local
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">8080</span>
<span class="token key atrule">users</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubelet
<span class="token key atrule">contexts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">context</span><span class="token punctuation">:</span>
    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> local
    <span class="token key atrule">user</span><span class="token punctuation">:</span> kubelet
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubelet<span class="token punctuation">-</span>context
<span class="token key atrule">current-context</span><span class="token punctuation">:</span> kubelet<span class="token punctuation">-</span>context
</pre>
<h6 class="mume-header" id="master-apiserver-rbacyaml">master-apiserver-rbac.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.9.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /hyperkube
      <span class="token punctuation">-</span> apiserver
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>storage<span class="token punctuation">-</span>media<span class="token punctuation">-</span>type=application/json
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=0.0.0.0
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=0.0.0.0
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>servers=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span>
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>allow<span class="token punctuation">-</span>privileged=true
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>anonymous<span class="token punctuation">-</span>auth=false
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>range=10.100.0.0/16
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=443
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=192.168.99.101
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>admission<span class="token punctuation">-</span>control=NamespaceLifecycle<span class="token punctuation">,</span>LimitRanger<span class="token punctuation">,</span>ServiceAccount<span class="token punctuation">,</span>DefaultStorageClass<span class="token punctuation">,</span>ResourceQuota
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver<span class="token punctuation">-</span>key.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/ca.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver<span class="token punctuation">-</span>key.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>runtime<span class="token punctuation">-</span>config=extensions/v1beta1=true<span class="token punctuation">,</span>networking.k8s.io/v1<span class="token punctuation">,</span>batch/v2alpha1=true<span class="token punctuation">,</span>admissionregistration.k8s.io/v1alpha1=true
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>mode=RBAC
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> local
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/ca<span class="token punctuation">-</span>certificates
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host

</pre>
<h6 class="mume-header" id="master-apiserveryaml">master-apiserver.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.9.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /hyperkube
      <span class="token punctuation">-</span> apiserver
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>storage<span class="token punctuation">-</span>media<span class="token punctuation">-</span>type=application/json
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=0.0.0.0
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=0.0.0.0
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>servers=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span>
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>allow<span class="token punctuation">-</span>privileged=true
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>anonymous<span class="token punctuation">-</span>auth=false
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>range=10.100.0.0/16
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=443
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=192.168.99.101
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>admission<span class="token punctuation">-</span>control=NamespaceLifecycle<span class="token punctuation">,</span>LimitRanger<span class="token punctuation">,</span>ServiceAccount<span class="token punctuation">,</span>DefaultStorageClass<span class="token punctuation">,</span>ResourceQuota
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver<span class="token punctuation">-</span>key.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/ca.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver<span class="token punctuation">-</span>key.pem
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> local
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/ca<span class="token punctuation">-</span>certificates
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host

</pre>
<h6 class="mume-header" id="master-controller-manageryaml">master-controller-manager.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.9.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /hyperkube
      <span class="token punctuation">-</span> controller<span class="token punctuation">-</span>manager
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>master=http<span class="token punctuation">:</span>//192.168.99.101<span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/apiserver<span class="token punctuation">-</span>key.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>root<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/ca.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>signing<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/ca.pem
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>signing<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/ssl/ca<span class="token punctuation">-</span>key.pem
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10252</span>
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>kubernetes
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/ssl
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/ca<span class="token punctuation">-</span>certificates

</pre>
<h6 class="mume-header" id="master-proxyyaml">master-proxy.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>proxy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>proxy
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.9.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /hyperkube
      <span class="token punctuation">-</span> proxy
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>master=http<span class="token punctuation">:</span>//192.168.99.101<span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>mode=iptables
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/ssl/certs
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ssl<span class="token punctuation">-</span>certs<span class="token punctuation">-</span>host
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/ca<span class="token punctuation">-</span>certificates

</pre>
<h6 class="mume-header" id="master-scheduleryaml">master-scheduler.yaml</h6>

<pre class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">image</span><span class="token punctuation">:</span> wangwg2/hyperkube<span class="token punctuation">-</span>amd64<span class="token punctuation">:</span>v1.9.2
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /hyperkube
      <span class="token punctuation">-</span> scheduler
      <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>master=http<span class="token punctuation">:</span>//192.168.99.101<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10251</span>
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
</pre>
<h6 class="mume-header" id="vagrantfile-user-data-1">vagrantfile-user-data</h6>

<pre class="language-yaml {as=&quot;yaml&quot;}"><span class="token comment" spellcheck="true">#cloud-config</span>

<span class="token punctuation">---</span>
<span class="token key atrule">write-files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/conf.d/nfs
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0644'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      OPTS_RPC_MOUNTD=""</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/bin/wupiao
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0755'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      #!/bin/bash
      # [w]ait [u]ntil [p]ort [i]s [a]ctually [o]pen
      [ -n "$1" ] &amp;&amp; \
        until curl -o /dev/null -sIf http://${1}; do \
          sleep 1 &amp;&amp; echo .;
        done;
      exit $?</span>

<span class="token key atrule">coreos</span><span class="token punctuation">:</span>
  <span class="token key atrule">flannel</span><span class="token punctuation">:</span>
    <span class="token key atrule">interface</span><span class="token punctuation">:</span> $public_ipv4
  <span class="token key atrule">units</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpcbind.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpc<span class="token punctuation">-</span>statd.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>member.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=etcd
        Documentation=https://github.com/coreos/etcd
        [Service]
        Environment='ETCD_IMAGE_TAG=v3.1.8'
        Environment='ETCD_DATA_DIR=/var/lib/etcd'
        Environment='ETCD_USER=etcd'
        Type=notify
        Restart=always
        RestartSec=5s
        LimitNOFILE=40000
        TimeoutStartSec=0
        ExecStart=/usr/lib/coreos/etcd-wrapper --name master \
            --listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \
            --advertise-client-urls http://$public_ipv4:2379,http://$public_ipv4:4001 \
            --listen-peer-urls http://$private_ipv4:2380,http://$private_ipv4:7001 \
            --initial-advertise-peer-urls http://$private_ipv4:2380 \
            --initial-cluster master=http://192.168.99.101:2380
        [Install]
        WantedBy=multi-user.target</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flanneld.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>network<span class="token punctuation">-</span>config.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=etcd-member.service
            [Service]
            ExecStartPre=/usr/bin/etcdctl set /coreos.com/network/config '{"Network":"10.244.0.0/16", "Backend": {"Type": "host-gw"}}'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 51<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>mirror.conf
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 40<span class="token punctuation">-</span>flannel.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=flanneld.service
            After=flanneld.service</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>options.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Service]
            Environment='DOCKER_OPTS=--storage-driver=overlay2 --registry-mirror=https://4ue5z1dy.mirror.aliyuncs.com'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> early<span class="token punctuation">-</span>docker.service
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>certs.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Generate Kubernetes API Server certificates
        ConditionPathExists=/tmp/make-certs.sh
        Requires=network-online.target
        After=network-online.target
        [Service]
        ExecStartPre=-/usr/sbin/groupadd -r kube-cert
        ExecStartPre=/usr/bin/chmod 755 /tmp/make-certs.sh
        ExecStart=/tmp/make-certs.sh
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>download.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Download Hyperkube Docker image
        Requires=docker.service
        After=docker.service
        ConditionPathExists=!/vagrant/artifacts/hyperkube_v1.9.2.tar
        [Service]
        # ExecStart=/usr/bin/docker pull gcr.io/google_containers/hyperkube-amd64:v1.9.2
        # ExecStart=/usr/bin/docker save --output /vagrant/artifacts/hyperkube_v1.9.2.tar gcr.io/google_containers/hyperkube-amd64:v1.9.2
        ExecStart=/usr/bin/docker pull wangwg2/hyperkube-amd64:v1.9.2
        ExecStart=/usr/bin/docker save --output /vagrant/artifacts/hyperkube_v1.9.2.tar wangwg2/hyperkube-amd64:v1.9.2
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>import.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Import Hyperkube Docker image
        Requires=docker.service
        After=docker.service
        ConditionPathExists=/vagrant/artifacts/hyperkube_v1.9.2.tar
        [Service]
        ExecStart=/usr/bin/docker load --input /vagrant/artifacts/hyperkube_v1.9.2.tar
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>kubelet.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Kubernetes Kubelet
        Documentation=https://github.com/GoogleCloudPlatform/kubernetes
        Requires=kube-certs.service
        Wants=hyperkube-download.service hyperkube-import.service
        After=kube-certs.service hyperkube-download.service hyperkube-import.service
        [Service]
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        ExecStartPre=-/usr/bin/docker rm -f kubelet
        ExecStart=/usr/bin/docker run \
          --volume=/:/rootfs:ro \
          --volume=/sys:/sys:ro \
          --volume=/etc/kubernetes:/etc/kubernetes:ro \
          --volume=/var/lib/docker/:/var/lib/docker:rw \
          --volume=/var/lib/kubelet/:/var/lib/kubelet:rw \
          --volume=/var/run:/var/run:rw \
          --net=host \
          --pid=host \
          --privileged=true \
          --name=kubelet \
          -d \
          wangwg2/hyperkube-amd64:v1.9.2 \
            /hyperkube kubelet \
            --address=$private_ipv4 \
            --network-plugin= \
            --pod-infra-container-image=wangwg2/pause-amd64:3.0 \
            --register-schedulable=false \
            --allow-privileged=true \
            --pod-manifest-path=/etc/kubernetes/manifests \
            --hostname-override=$public_ipv4 \
            --cluster_dns=10.100.0.10 \
            --cluster_domain=cluster.local \
            --kubeconfig=/etc/kubernetes/master-kubeconfig.yaml
        Restart=on-failure
        RestartSec=10
        WorkingDirectory=/root/
        [Install]
        WantedBy=multi-user.target</span>
  <span class="token key atrule">update</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> alpha
    <span class="token key atrule">reboot-strategy</span><span class="token punctuation">:</span> off

</pre>
<h6 class="mume-header" id="make-certssh"><a href="http://make-certs.sh">make-certs.sh</a></h6>

<pre class="language-sh"><span class="token shebang important">#!/bin/sh</span> -

<span class="token keyword">set</span> -o errexit
<span class="token keyword">set</span> -o nounset
<span class="token keyword">set</span> -o pipefail

cert_group<span class="token operator">=</span>kube-cert
cert_dir<span class="token operator">=</span>/etc/kubernetes/ssl

pem_ca<span class="token operator">=</span><span class="token variable">$cert_dir</span>/ca.pem
pem_ca_key<span class="token operator">=</span><span class="token variable">$cert_dir</span>/ca-key.pem
pem_server<span class="token operator">=</span><span class="token variable">$cert_dir</span>/apiserver.pem
pem_server_key<span class="token operator">=</span><span class="token variable">$cert_dir</span>/apiserver-key.pem
pem_server_csr<span class="token operator">=</span><span class="token variable">$cert_dir</span>/apiserver-csr.pem

pem_admin<span class="token operator">=</span>/vagrant/artifacts/tls/admin.pem
pem_admin_key<span class="token operator">=</span>/vagrant/artifacts/tls/admin-key.pem
pem_admin_csr<span class="token operator">=</span>/vagrant/artifacts/tls/admin-csr.pem

<span class="token comment" spellcheck="true"># Generate TLS artifacts</span>
<span class="token function">mkdir</span> -p <span class="token string">"<span class="token variable">$cert_dir</span>"</span>

openssl genrsa -out <span class="token variable">$pem_ca_key</span> 2048 
openssl req -x509 -new -nodes -key <span class="token variable">$pem_ca_key</span> -days 10000 -out <span class="token variable">$pem_ca</span> -subj <span class="token string">"/CN=kube-ca"</span>

openssl genrsa -out <span class="token variable">$pem_server_key</span> 2048
openssl req -new -key <span class="token variable">$pem_server_key</span> -out <span class="token variable">$pem_server_csr</span> -subj <span class="token string">"/CN=kube-apiserver"</span> -config /tmp/openssl.cnf
openssl x509 -req -in <span class="token variable">$pem_server_csr</span> -CA <span class="token variable">$pem_ca</span> -CAkey <span class="token variable">$pem_ca_key</span> -CAcreateserial -out <span class="token variable">$pem_server</span> -days 365 -extensions v3_req -extfile /tmp/openssl.cnf

<span class="token comment" spellcheck="true"># Make server certs accessible to apiserver.</span>
<span class="token function">chgrp</span> <span class="token variable">$cert_group</span> <span class="token variable">$pem_ca</span> <span class="token variable">$pem_ca_key</span> <span class="token variable">$pem_server</span> <span class="token variable">$pem_server_key</span>
<span class="token function">chmod</span> 600 <span class="token variable">$pem_ca_key</span> <span class="token variable">$pem_server_key</span>
<span class="token function">chmod</span> 660 <span class="token variable">$pem_ca</span> <span class="token variable">$pem_server</span>

<span class="token comment" spellcheck="true"># Copy CA stuff to host so worked nodes can use it</span>
<span class="token function">cp</span> <span class="token variable">$pem_ca</span> <span class="token variable">$pem_ca_key</span> /vagrant/artifacts/tls

<span class="token comment" spellcheck="true"># Generate admin</span>
openssl genrsa -out <span class="token variable">$pem_admin_key</span> 2048
openssl req -new -key <span class="token variable">$pem_admin_key</span> -out <span class="token variable">$pem_admin_csr</span> -subj <span class="token string">"/CN=kube-admin"</span>
openssl x509 -req -in <span class="token variable">$pem_admin_csr</span> -CA <span class="token variable">$pem_ca</span> -CAkey <span class="token variable">$pem_ca_key</span> -CAcreateserial -out <span class="token variable">$pem_admin</span> -days 365

</pre>
<h6 class="mume-header" id="opensslcnf">openssl.cnf</h6>

<pre class="language-yaml {as=&quot;yaml&quot;}"><span class="token punctuation">[</span>req<span class="token punctuation">]</span>
req_extensions = v3_req
distinguished_name = req_distinguished_name
<span class="token punctuation">[</span>req_distinguished_name<span class="token punctuation">]</span>
<span class="token punctuation">[</span> v3_req <span class="token punctuation">]</span>
basicConstraints = CA<span class="token punctuation">:</span><span class="token boolean important">FALSE</span>
keyUsage = nonRepudiation<span class="token punctuation">,</span> digitalSignature<span class="token punctuation">,</span> keyEncipherment
subjectAltName = @alt_names
<span class="token punctuation">[</span>alt_names<span class="token punctuation">]</span>
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.__DNS_DOMAIN__
IP.1 = 10.100.0.1
IP.2 = __MASTER_IP__
</pre>
<hr>
<h3 class="mume-header" id="%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95%E5%AE%BF%E4%B8%BB%E6%9C%BA">文件清单（宿主机）</h3>

<h6 class="mume-header" id="vagrantfile">Vagrantfile</h6>

<pre class="language-ruby {as=&quot;ruby&quot;}"><span class="token comment" spellcheck="true"># -*- mode: ruby -*-</span>
<span class="token comment" spellcheck="true"># vi: set ft=ruby :</span>

<span class="token keyword">require</span> <span class="token string">'fileutils'</span>
<span class="token keyword">require</span> <span class="token string">'net/http'</span>
<span class="token keyword">require</span> <span class="token string">'open-uri'</span>
<span class="token keyword">require</span> <span class="token string">'json'</span>
<span class="token keyword">require</span> <span class="token string">'date'</span>
<span class="token keyword">require</span> <span class="token string">'pathname'</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span>
  <span class="token keyword">def</span> <span class="token function">redefine_const</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token function">__send__</span><span class="token punctuation">(</span><span class="token symbol">:remove_const</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">if</span> const_defined<span class="token operator">?</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token function">const_set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">module</span> <span class="token constant">OS</span>
  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
    <span class="token punctuation">(</span><span class="token operator">/</span>cygwin<span class="token operator">|</span>mswin<span class="token operator">|</span>mingw<span class="token operator">|</span>bccwin<span class="token operator">|</span>wince<span class="token operator">|</span>emx<span class="token operator">/</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token constant">RUBY_PLATFORM</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nil</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>mac<span class="token operator">?</span>
   <span class="token punctuation">(</span><span class="token operator">/</span>darwin<span class="token operator">/</span> <span class="token operator">=</span><span class="token operator">~</span> <span class="token constant">RUBY_PLATFORM</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">nil</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>unix<span class="token operator">?</span>
    <span class="token operator">!</span><span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
  <span class="token keyword">end</span>

  <span class="token keyword">def</span> <span class="token constant">OS</span><span class="token punctuation">.</span>linux<span class="token operator">?</span>
    <span class="token constant">OS</span><span class="token punctuation">.</span>unix<span class="token operator">?</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token constant">OS</span><span class="token punctuation">.</span>mac<span class="token operator">?</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

required_plugins <span class="token operator">=</span> <span class="token string">%w(vagrant-triggers)</span>

<span class="token comment" spellcheck="true"># check either 'http_proxy' or 'HTTP_PROXY' environment variable</span>
enable_proxy <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'http_proxy'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>empty<span class="token operator">?</span>
<span class="token keyword">if</span> enable_proxy
  required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-proxyconf'</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
  required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-winnfsd'</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

required_plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'vagrant-timezone'</span><span class="token punctuation">)</span>

required_plugins<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>plugin<span class="token operator">|</span>
  need_restart <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">unless</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span> plugin
    system <span class="token string">"vagrant plugin install <span class="token interpolation"><span class="token delimiter tag">#{</span>plugin<span class="token delimiter tag">}</span></span>"</span>
    need_restart <span class="token operator">=</span> <span class="token keyword">true</span>
  <span class="token keyword">end</span>
  exec <span class="token string">"vagrant <span class="token interpolation"><span class="token delimiter tag">#{</span>ARGV<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token delimiter tag">}</span></span>"</span> <span class="token keyword">if</span> need_restart
<span class="token keyword">end</span>

<span class="token comment" spellcheck="true"># Vagrantfile API/syntax version. Don't touch unless you know what you're doing!</span>
<span class="token constant">VAGRANTFILE_API_VERSION</span> <span class="token operator">=</span> <span class="token string">"2"</span>
<span class="token constant">Vagrant</span><span class="token punctuation">.</span>require_version <span class="token string">">= 1.8.6"</span>

<span class="token constant">MASTER_YAML</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"master.yaml"</span><span class="token punctuation">)</span>
<span class="token constant">NODE_YAML</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"node.yaml"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># AUTHORIZATION MODE is a setting for enabling or disabling RBAC for your Kubernetes Cluster</span>
<span class="token comment" spellcheck="true"># The default mode is ABAC.</span>
<span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'AUTHORIZATION_MODE'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'AlwaysAllow'</span>

<span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
  <span class="token constant">CERTS_MASTER_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-master-rbac.sh"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
  <span class="token constant">CERTS_MASTER_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-master.sh"</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token constant">CERTS_MASTER_CONF</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/openssl-master.cnf.tmpl"</span><span class="token punctuation">)</span>
<span class="token constant">CERTS_NODE_SCRIPT</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/make-certs-node.sh"</span><span class="token punctuation">)</span>
<span class="token constant">CERTS_NODE_CONF</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"tls/openssl-node.cnf.tmpl"</span><span class="token punctuation">)</span>

<span class="token constant">MANIFESTS_DIR</span> <span class="token operator">=</span> <span class="token constant">Pathname</span><span class="token punctuation">.</span><span class="token function">getwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"manifests"</span><span class="token punctuation">)</span>

<span class="token constant">USE_DOCKERCFG</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'USE_DOCKERCFG'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">false</span>
<span class="token constant">DOCKERCFG</span> <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">expand_path</span><span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DOCKERCFG'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"~/.dockercfg"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># DOCKER_OPTIONS = ENV['DOCKER_OPTIONS'] || ''</span>
<span class="token constant">DOCKER_OPTIONS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DOCKER_OPTIONS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'--registry-mirror=https://4ue5z1dy.mirror.aliyuncs.com'</span>


<span class="token constant">KUBERNETES_VERSION</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'KUBERNETES_VERSION'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'1.9.2'</span>

<span class="token constant">CHANNEL</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'CHANNEL'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'alpha'</span>

<span class="token comment" spellcheck="true">#if CHANNEL != 'alpha'</span>
<span class="token comment" spellcheck="true">#  puts "============================================================================="</span>
<span class="token comment" spellcheck="true">#  puts "As this is a fastly evolving technology CoreOS' alpha channel is the only one"</span>
<span class="token comment" spellcheck="true">#  puts "expected to behave reliably. While one can invoke the beta or stable channels"</span>
<span class="token comment" spellcheck="true">#  puts "please be aware that your mileage may vary a whole lot."</span>
<span class="token comment" spellcheck="true">#  puts "So, before submitting a bug, in this project, or upstreams (either kubernetes"</span>
<span class="token comment" spellcheck="true">#  puts "or CoreOS) please make sure it (also) happens in the (default) alpha channel."</span>
<span class="token comment" spellcheck="true">#  puts "============================================================================="</span>
<span class="token comment" spellcheck="true">#end</span>

<span class="token constant">COREOS_VERSION</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'COREOS_VERSION'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'latest'</span>
upstream <span class="token operator">=</span> <span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>.release.core-os.net/amd64-usr/<span class="token interpolation"><span class="token delimiter tag">#{</span>COREOS_VERSION<span class="token delimiter tag">}</span></span>"</span>
<span class="token keyword">if</span> <span class="token constant">COREOS_VERSION</span> <span class="token operator">==</span> <span class="token string">"latest"</span>
  upstream <span class="token operator">=</span> <span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>.release.core-os.net/amd64-usr/current"</span>
  url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/version.txt"</span>
  <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token function">redefine_const</span><span class="token punctuation">(</span><span class="token symbol">:COREOS_VERSION</span><span class="token punctuation">,</span>
    <span class="token function">open</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token regex">/COREOS_VERSION=.*/</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">'COREOS_VERSION='</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token constant">NODES</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODES'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2</span>

<span class="token constant">MASTER_MEM</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'MASTER_MEM'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1024</span>
<span class="token constant">MASTER_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'MASTER_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>

<span class="token constant">NODE_MEM</span><span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODE_MEM'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">2048</span>
<span class="token constant">NODE_CPUS</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NODE_CPUS'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true"># BASE_IP_ADDR = ENV['BASE_IP_ADDR'] || "172.17.8"</span>
<span class="token constant">BASE_IP_ADDR</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'BASE_IP_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"192.168.99"</span>

<span class="token constant">DNS_PROVIDER</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DNS_PROVIDER'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"coredns"</span>
<span class="token constant">DNS_DOMAIN</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'DNS_DOMAIN'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"cluster.local"</span>

<span class="token constant">SERIAL_LOGGING</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'SERIAL_LOGGING'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token constant">GUI</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'GUI'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token constant">USE_KUBE_UI</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'USE_KUBE_UI'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">false</span>

<span class="token constant">BOX_TIMEOUT_COUNT</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'BOX_TIMEOUT_COUNT'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">100</span>

<span class="token keyword">if</span> enable_proxy
  <span class="token constant">HTTP_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTP_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'http_proxy'</span><span class="token punctuation">]</span>
  <span class="token constant">HTTPS_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'HTTPS_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'https_proxy'</span><span class="token punctuation">]</span>
  <span class="token constant">NO_PROXY</span> <span class="token operator">=</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'NO_PROXY'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'no_proxy'</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">"localhost"</span>
<span class="token keyword">end</span>

<span class="token constant">REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ENV</span><span class="token punctuation">[</span><span class="token string">'REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_s<span class="token punctuation">.</span>downcase <span class="token operator">==</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># if this is set true, remember to use --provision when executing vagrant up / reload</span>

<span class="token comment" spellcheck="true"># Read YAML file with mountpoint details</span>
<span class="token constant">MOUNT_POINTS</span> <span class="token operator">=</span> <span class="token constant">YAML</span><span class="token punctuation">:</span><span class="token symbol">:load_file</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"synced_folders.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token constant">Vagrant</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token constant">VAGRANTFILE_API_VERSION</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>config<span class="token operator">|</span>
  <span class="token comment" spellcheck="true"># always use host timezone in VMs</span>
  config<span class="token punctuation">.</span>timezone<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token symbol">:host</span>

  <span class="token comment" spellcheck="true"># always use Vagrants' insecure key</span>
  config<span class="token punctuation">.</span>ssh<span class="token punctuation">.</span>insert_key <span class="token operator">=</span> <span class="token keyword">false</span>
  config<span class="token punctuation">.</span>ssh<span class="token punctuation">.</span>forward_agent <span class="token operator">=</span> <span class="token keyword">true</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">"coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_version <span class="token operator">=</span> <span class="token string">"= <span class="token interpolation"><span class="token delimiter tag">#{</span>COREOS_VERSION<span class="token delimiter tag">}</span></span>"</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/coreos_production_vagrant.json"</span>

  <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>vmware<span class="token operator">|</span>
    config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider vmware <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token punctuation">,</span> override<span class="token operator">|</span>
      override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>upstream<span class="token delimiter tag">}</span></span>/coreos_production_vagrant_vmware_fusion.json"</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:parallels</span> <span class="token keyword">do</span> <span class="token operator">|</span>vb<span class="token punctuation">,</span> override<span class="token operator">|</span>
    override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box <span class="token operator">=</span> <span class="token string">"AntonioMeireles/coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
    override<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>box_url <span class="token operator">=</span> <span class="token string">"https://vagrantcloud.com/AntonioMeireles/coreos-<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>"</span>
  <span class="token keyword">end</span>

  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:virtualbox</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
    <span class="token comment" spellcheck="true"># On VirtualBox, we don't have guest additions or a functional vboxsf</span>
    <span class="token comment" spellcheck="true"># in CoreOS, so tell Vagrant that so it can be smarter.</span>
    v<span class="token punctuation">.</span>check_guest_additions <span class="token operator">=</span> <span class="token keyword">false</span>
    v<span class="token punctuation">.</span>functional_vboxsf     <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>
  config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:parallels</span> <span class="token keyword">do</span> <span class="token operator">|</span>p<span class="token operator">|</span>
    p<span class="token punctuation">.</span>update_guest_tools <span class="token operator">=</span> <span class="token keyword">false</span>
    p<span class="token punctuation">.</span>check_guest_tools <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># plugin conflict</span>
  <span class="token keyword">if</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">"vagrant-vbguest"</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    config<span class="token punctuation">.</span>vbguest<span class="token punctuation">.</span>auto_update <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">end</span>

  <span class="token comment" spellcheck="true"># setup VM proxy to system proxy environment</span>
  <span class="token keyword">if</span> <span class="token constant">Vagrant</span><span class="token punctuation">.</span>has_plugin<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">"vagrant-proxyconf"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> enable_proxy
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>http <span class="token operator">=</span> <span class="token constant">HTTP_PROXY</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>https <span class="token operator">=</span> <span class="token constant">HTTPS_PROXY</span>
    <span class="token comment" spellcheck="true"># most http tools, like wget and curl do not undestand IP range</span>
    <span class="token comment" spellcheck="true"># thus adding each node one by one to no_proxy</span>
    no_proxies <span class="token operator">=</span> <span class="token constant">NO_PROXY</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token constant">NODES</span><span class="token punctuation">.</span>to_i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>i<span class="token operator">|</span>
      vm_ip_addr <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>
      <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token function">redefine_const</span><span class="token punctuation">(</span><span class="token symbol">:NO_PROXY</span><span class="token punctuation">,</span>
        <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>NO_PROXY<span class="token delimiter tag">}</span></span>,<span class="token interpolation"><span class="token delimiter tag">#{</span>vm_ip_addr<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">)</span> <span class="token keyword">unless</span> no_proxies<span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span>vm_ip_addr<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>no_proxy <span class="token operator">=</span> <span class="token constant">NO_PROXY</span>
    <span class="token comment" spellcheck="true"># proxyconf plugin use wrong approach to set Docker proxy for CoreOS</span>
    <span class="token comment" spellcheck="true"># force proxyconf to skip Docker proxy setup</span>
    config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token punctuation">{</span> docker<span class="token punctuation">:</span> <span class="token keyword">false</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span>

  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token constant">NODES</span><span class="token punctuation">.</span>to_i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>i<span class="token operator">|</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">1</span>
      hostname <span class="token operator">=</span> <span class="token string">"master"</span>
      <span class="token constant">ETCD_SEED_CLUSTER</span> <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>hostname<span class="token delimiter tag">}</span></span>=http://<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>:2380"</span>
      cfg <span class="token operator">=</span> <span class="token constant">MASTER_YAML</span>
      memory <span class="token operator">=</span> <span class="token constant">MASTER_MEM</span>
      cpus <span class="token operator">=</span> <span class="token constant">MASTER_CPUS</span>
      <span class="token constant">MASTER_IP</span><span class="token operator">=</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>
    <span class="token keyword">else</span>
      hostname <span class="token operator">=</span> <span class="token string">"node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      cfg <span class="token operator">=</span> <span class="token constant">NODE_YAML</span>
      memory <span class="token operator">=</span> <span class="token constant">NODE_MEM</span>
      cpus <span class="token operator">=</span> <span class="token constant">NODE_CPUS</span>
    <span class="token keyword">end</span>

    config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>define vmName <span class="token operator">=</span> hostname <span class="token keyword">do</span> <span class="token operator">|</span>kHost<span class="token operator">|</span>
      kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>hostname <span class="token operator">=</span> vmName

      <span class="token comment" spellcheck="true"># suspend / resume is hard to be properly supported because we have no way</span>
      <span class="token comment" spellcheck="true"># to assure the fully deterministic behavior of whatever is inside the VMs</span>
      <span class="token comment" spellcheck="true"># when faced with XXL clock gaps... so we just disable this functionality.</span>
      kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>reject <span class="token punctuation">[</span><span class="token symbol">:suspend</span><span class="token punctuation">,</span> <span class="token symbol">:resume</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
        info <span class="token string">"'vagrant suspend' and 'vagrant resume' are disabled."</span>
        info <span class="token string">"- please do use 'vagrant halt' and 'vagrant up' instead."</span>
      <span class="token keyword">end</span>

      config<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>instead_of <span class="token symbol">:reload</span> <span class="token keyword">do</span>
        exec <span class="token string">"vagrant halt &amp;&amp; vagrant up"</span>
        exit
      <span class="token keyword">end</span>

      <span class="token comment" spellcheck="true"># vagrant-triggers has no concept of global triggers so to avoid having</span>
      <span class="token comment" spellcheck="true"># then to run as many times as the total number of VMs we only call them</span>
      <span class="token comment" spellcheck="true"># in the master (re: emyl/vagrant-triggers#13)...</span>
      <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:provision</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: setting up Kubernetes master..."</span>
          info <span class="token string">"Setting Kubernetes version <span class="token interpolation"><span class="token delimiter tag">#{</span>KUBERNETES_VERSION<span class="token delimiter tag">}</span></span>"</span>

          <span class="token comment" spellcheck="true"># create setup file</span>
          setupFile <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/setup"</span>
          <span class="token comment" spellcheck="true"># find and replace kubernetes version and master IP in setup file</span>
          setupData <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"setup.tmpl"</span><span class="token punctuation">)</span>
          setupData <span class="token operator">=</span> setupData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">"__KUBERNETES_VERSION__"</span><span class="token punctuation">,</span> <span class="token constant">KUBERNETES_VERSION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          setupData <span class="token operator">=</span> setupData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">"__MASTER_IP__"</span><span class="token punctuation">,</span> <span class="token constant">MASTER_IP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> enable_proxy
            <span class="token comment" spellcheck="true"># remove __PROXY_LINE__ flag and set __NO_PROXY__</span>
            setupData <span class="token operator">=</span> setupData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">"__PROXY_LINE__"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            setupData <span class="token operator">=</span> setupData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">"__NO_PROXY__"</span><span class="token punctuation">,</span> <span class="token constant">NO_PROXY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            <span class="token comment" spellcheck="true"># remove lines that start with __PROXY_LINE__</span>
            setupData <span class="token operator">=</span> setupData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token regex">/^\s*__PROXY_LINE__.*$\n/</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">end</span>
          <span class="token comment" spellcheck="true"># write new setup data to setup file</span>
          <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>setupFile<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>f<span class="token operator">|</span>
            f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>setupData<span class="token punctuation">)</span>
          <span class="token keyword">end</span>

          <span class="token comment" spellcheck="true"># give setup file executable permissions</span>
          system <span class="token string">"chmod +x temp/setup"</span>

          <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
              <span class="token comment" spellcheck="true"># create dns-deployment.yaml file</span>
              dnsFile <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/dns-deployment.yaml"</span>
              <span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
                dnsData <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/kube-dns/dns-deployment-rbac.yaml.tmpl"</span><span class="token punctuation">)</span>
              <span class="token keyword">else</span>
                dnsData <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/kube-dns/dns-deployment.yaml.tmpl"</span><span class="token punctuation">)</span>
              <span class="token keyword">end</span>
              dnsData <span class="token operator">=</span> dnsData<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span><span class="token string">"__DNS_DOMAIN__"</span><span class="token punctuation">,</span> <span class="token constant">DNS_DOMAIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment" spellcheck="true"># write new setup data to setup file</span>
              <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>dnsFile<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>f<span class="token operator">|</span>
                f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>dnsData<span class="token punctuation">)</span>
              <span class="token keyword">end</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
                <span class="token comment" spellcheck="true"># system "#{__dir__}/plugins/dns/coredns/deploy.sh 10.100.0.10/24 #{DNS_DOMAIN} #{__dir__}/plugins/dns/coredns/coredns.yaml.sed > #{__dir__}/temp/coredns-deployment.yaml"</span>
                system <span class="token string">"cp <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/plugins/dns/coredns/coredns.yaml.sed <span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/coredns-deployment.yaml"</span>
                system <span class="token string">"sed -i -e s/CLUSTER_DNS_IP/10.100.0.10/g -e s/CLUSTER_DOMAIN/<span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span>/g -e s?SERVICE_CIDR?10.100.0.10\/24?g temp/coredns-deployment.yaml"</span>
              <span class="token keyword">end</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:resume</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          <span class="token keyword">unless</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
            info <span class="token string">"Sanitizing stuff..."</span>
            system <span class="token string">"ssh-add ~/.vagrant.d/insecure_private_key"</span>
            system <span class="token string">"rm -rf ~/.fleetctl/known_hosts"</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          info <span class="token string">"Waiting for Kubernetes master to become ready..."</span>
          j<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">URI</span><span class="token punctuation">(</span><span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>:8080"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nil</span>
          loop <span class="token keyword">do</span>
            j <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">begin</span>
              res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
            <span class="token keyword">rescue</span>
              sleep <span class="token number">10</span>
            <span class="token keyword">end</span>
            <span class="token keyword">break</span> <span class="token keyword">if</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span> <span class="token keyword">or</span> j <span class="token operator">>=</span> <span class="token constant">BOX_TIMEOUT_COUNT</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
            info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: successfully deployed <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span>"</span>
          <span class="token keyword">else</span>
            info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: failed to deploy <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span> within timeout count of <span class="token interpolation"><span class="token delimiter tag">#{</span>BOX_TIMEOUT_COUNT<span class="token delimiter tag">}</span></span>"</span>
          <span class="token keyword">end</span>

          info <span class="token string">"Installing kubectl for the Kubernetes version we just bootstrapped..."</span>
          <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
            run_remote <span class="token string">"sudo -u core /bin/sh /home/core/kubectlsetup install"</span>
          <span class="token keyword">else</span>
            system <span class="token string">"./temp/setup install"</span>
          <span class="token keyword">end</span>

          <span class="token comment" spellcheck="true"># set cluster</span>
          <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
            run_remote <span class="token string">"/opt/bin/kubectl config set-cluster default-cluster --server=https://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span> --certificate-authority=/vagrant/artifacts/tls/ca.pem"</span>
            run_remote <span class="token string">"/opt/bin/kubectl config set-credentials default-admin --certificate-authority=/vagrant/artifacts/tls/ca.pem --client-key=/vagrant/artifacts/tls/admin-key.pem --client-certificate=/vagrant/artifacts/tls/admin.pem"</span>
            run_remote <span class="token string">"/opt/bin/kubectl config set-context local --cluster=default-cluster --user=default-admin"</span>
            run_remote <span class="token string">"/opt/bin/kubectl config use-context local"</span>
          <span class="token keyword">else</span>
            system <span class="token string">"kubectl config set-cluster default-cluster --server=https://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span> --certificate-authority=artifacts/tls/ca.pem"</span>
            system <span class="token string">"kubectl config set-credentials default-admin --certificate-authority=artifacts/tls/ca.pem --client-key=artifacts/tls/admin-key.pem --client-certificate=artifacts/tls/admin.pem"</span>
            system <span class="token string">"kubectl config set-context local --cluster=default-cluster --user=default-admin"</span>
            system <span class="token string">"kubectl config use-context local"</span>
          <span class="token keyword">end</span>

          info <span class="token string">"Configuring Kubernetes DNS..."</span>

          <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
              res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/replicationcontrollers/kube-dns'</span>
              <span class="token keyword">begin</span>
                res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
              <span class="token keyword">rescue</span>
              <span class="token keyword">end</span>
              <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
                <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
                  run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-deployment.yaml"</span>
                <span class="token keyword">else</span>
                  system <span class="token string">"kubectl create -f temp/dns-deployment.yaml"</span>
                <span class="token keyword">end</span>
              <span class="token keyword">end</span>

              res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/services/kube-dns'</span>
              <span class="token keyword">begin</span>
                res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
              <span class="token keyword">rescue</span>
              <span class="token keyword">end</span>
              <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
                <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
                  run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-configmap.yaml"</span>
                  run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dns-service.yaml"</span>
                <span class="token keyword">else</span>
                  system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-configmap.yaml"</span>
                  <span class="token comment" spellcheck="true"># Use service file specific to RBAC</span>
                  <span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
                    system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-service-rbac.yaml"</span>
                  <span class="token keyword">else</span>
                    system <span class="token string">"kubectl create -f plugins/dns/kube-dns/dns-service.yaml"</span>
                  <span class="token keyword">end</span>
                <span class="token keyword">end</span>
              <span class="token keyword">end</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
                  res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/deployment/coredns'</span>
                  <span class="token keyword">begin</span>
                    res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
                  <span class="token keyword">rescue</span>
                  <span class="token keyword">end</span>
                  <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
                    <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
                      run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/coredns-deployment.yaml"</span>
                    <span class="token keyword">else</span>
                      system <span class="token string">"kubectl create -f temp/coredns-deployment.yaml"</span>
                    <span class="token keyword">end</span>
                  <span class="token keyword">end</span>
               <span class="token keyword">end</span>
          <span class="token keyword">end</span>

          <span class="token keyword">if</span> <span class="token constant">USE_KUBE_UI</span>
            info <span class="token string">"Configuring Kubernetes dashboard..."</span>

            res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/replicationcontrollers/kubernetes-dashboard'</span>
            <span class="token keyword">begin</span>
              res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
            <span class="token keyword">rescue</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
              <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
                run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dashboard-deployment.yaml"</span>
              <span class="token keyword">else</span>
                system <span class="token string">"kubectl create -f plugins/dashboard/dashboard-deployment.yaml"</span>
              <span class="token keyword">end</span>
            <span class="token keyword">end</span>

            res<span class="token punctuation">,</span> uri<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token string">'/api/v1/namespaces/kube-system/services/kubernetes-dashboard'</span>
            <span class="token keyword">begin</span>
              res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
            <span class="token keyword">rescue</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> res<span class="token punctuation">.</span>is_a<span class="token operator">?</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPSuccess</span>
              <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
                run_remote <span class="token string">"/opt/bin/kubectl create -f /home/core/dashboard-service.yaml"</span>
              <span class="token keyword">else</span>
                system <span class="token string">"kubectl create -f plugins/dashboard/dashboard-service.yaml"</span>
              <span class="token keyword">end</span>
            <span class="token keyword">end</span>

            info <span class="token string">"Kubernetes dashboard will be available at http://<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>:8080/ui"</span>
          <span class="token keyword">end</span>

        <span class="token keyword">end</span>

        <span class="token comment" spellcheck="true"># copy setup files to master vm if host is windows</span>
        <span class="token keyword">if</span> <span class="token constant">OS</span><span class="token punctuation">.</span>windows<span class="token operator">?</span>
          kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"temp/setup"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/kubectlsetup"</span>

          <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"kube-dns"</span>
              kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"plugins/dns/kube-dns/dns-configmap.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dns-configmap.yaml"</span>
              kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"temp/dns-deployment.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dns-deployment.yaml"</span>
              kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"plugins/dns/kube-dns/dns-service.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dns-service.yaml"</span>
              kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"plugins/dns/kube-dns/dns-service-rbac.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dns-service-rbac.yaml"</span>
          <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token constant">DNS_PROVIDER</span> <span class="token operator">==</span> <span class="token string">"coredns"</span>
                    kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"temp/coredns-deployment.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/coredns-deployment.yaml"</span>
               <span class="token keyword">end</span>
          <span class="token keyword">end</span>

          <span class="token keyword">if</span> <span class="token constant">USE_KUBE_UI</span>
            kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"plugins/dashboard/dashboard-deployment.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dashboard-deployment.yaml"</span>
            kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"plugins/dashboard/dashboard-service.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/dashboard-service.yaml"</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment" spellcheck="true"># clean temp directory after master is destroyed</span>
        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:destroy</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          <span class="token constant">FileUtils</span><span class="token punctuation">.</span><span class="token function">rm_rf</span><span class="token punctuation">(</span><span class="token builtin">Dir</span><span class="token punctuation">.</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/temp/*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token constant">FileUtils</span><span class="token punctuation">.</span><span class="token function">rm_rf</span><span class="token punctuation">(</span><span class="token builtin">Dir</span><span class="token punctuation">.</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>__dir__<span class="token delimiter tag">}</span></span>/artifacts/tls/*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">,</span> <span class="token symbol">:provision</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: setting up node..."</span>
        <span class="token keyword">end</span>

        kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>after <span class="token punctuation">[</span><span class="token symbol">:up</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
          info <span class="token string">"Waiting for Kubernetes minion [node-%02d"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] to become ready..."</span>
          j<span class="token punctuation">,</span> uri<span class="token punctuation">,</span> hasResponse <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">URI</span><span class="token punctuation">(</span><span class="token string">"http://<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>:10250"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">false</span>
          loop <span class="token keyword">do</span>
            j <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">begin</span>
              res <span class="token operator">=</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTP</span><span class="token punctuation">.</span><span class="token function">get_response</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
              hasResponse <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">rescue</span> <span class="token constant">Net</span><span class="token punctuation">:</span><span class="token symbol">:HTTPBadResponse</span>
              hasResponse <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">rescue</span>
              sleep <span class="token number">10</span>
            <span class="token keyword">end</span>
            <span class="token keyword">break</span> <span class="token keyword">if</span> hasResponse <span class="token keyword">or</span> j <span class="token operator">>=</span> <span class="token constant">BOX_TIMEOUT_COUNT</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> hasResponse
            info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: successfully deployed <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span>"</span>
          <span class="token keyword">else</span>
            info <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>Time<span class="token punctuation">.</span>now<span class="token delimiter tag">}</span></span>: failed to deploy <span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span> within timeout count of <span class="token interpolation"><span class="token delimiter tag">#{</span>BOX_TIMEOUT_COUNT<span class="token delimiter tag">}</span></span>"</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      kHost<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span>before <span class="token punctuation">[</span><span class="token symbol">:halt</span><span class="token punctuation">,</span> <span class="token symbol">:reload</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token constant">REMOVE_VAGRANTFILE_USER_DATA_BEFORE_HALT</span>
          run_remote <span class="token string">"sudo rm -f /var/lib/coreos-vagrant/vagrantfile-user-data"</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      <span class="token keyword">if</span> <span class="token constant">SERIAL_LOGGING</span>
        logdir <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>__FILE__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"log"</span><span class="token punctuation">)</span>
        <span class="token constant">FileUtils</span><span class="token punctuation">.</span><span class="token function">mkdir_p</span><span class="token punctuation">(</span>logdir<span class="token punctuation">)</span>

        serialFile <span class="token operator">=</span> <span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>logdir<span class="token punctuation">,</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>vmName<span class="token delimiter tag">}</span></span>-serial.txt"</span><span class="token punctuation">)</span>
        <span class="token constant">FileUtils</span><span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>serialFile<span class="token punctuation">)</span>

        <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>vmware<span class="token operator">|</span>
          kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider vmware <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token punctuation">,</span> override<span class="token operator">|</span>
            v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"serial0.present"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"TRUE"</span>
            v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"serial0.fileType"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"file"</span>
            v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"serial0.fileName"</span><span class="token punctuation">]</span> <span class="token operator">=</span> serialFile
            v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"serial0.tryNoRxLoss"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"FALSE"</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:virtualbox</span> <span class="token keyword">do</span> <span class="token operator">|</span>vb<span class="token punctuation">,</span> override<span class="token operator">|</span>
          vb<span class="token punctuation">.</span>customize <span class="token punctuation">[</span><span class="token string">"modifyvm"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--uart1"</span><span class="token punctuation">,</span> <span class="token string">"0x3F8"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">]</span>
          vb<span class="token punctuation">.</span>customize <span class="token punctuation">[</span><span class="token string">"modifyvm"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--uartmode1"</span><span class="token punctuation">,</span> serialFile<span class="token punctuation">]</span>
        <span class="token keyword">end</span>
        <span class="token comment" spellcheck="true"># supported since vagrant-parallels 1.3.7</span>
        <span class="token comment" spellcheck="true"># https://github.com/Parallels/vagrant-parallels/issues/164</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider <span class="token symbol">:parallels</span> <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
          v<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span><span class="token string">"post-import"</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">"set"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--device-add"</span><span class="token punctuation">,</span> <span class="token string">"serial"</span><span class="token punctuation">,</span> <span class="token string">"--output"</span><span class="token punctuation">,</span> serialFile<span class="token punctuation">]</span><span class="token punctuation">)</span>
          v<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span><span class="token string">"pre-boot"</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">"set"</span><span class="token punctuation">,</span> <span class="token symbol">:id</span><span class="token punctuation">,</span> <span class="token string">"--device-set"</span><span class="token punctuation">,</span> <span class="token string">"serial0"</span><span class="token punctuation">,</span> <span class="token string">"--output"</span><span class="token punctuation">,</span> serialFile<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">,</span> <span class="token string">"virtualbox"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider h <span class="token keyword">do</span> <span class="token operator">|</span>vb<span class="token operator">|</span>
          vb<span class="token punctuation">.</span>gui <span class="token operator">=</span> <span class="token constant">GUI</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
      <span class="token punctuation">[</span><span class="token string">"vmware_fusion"</span><span class="token punctuation">,</span> <span class="token string">"vmware_workstation"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider h <span class="token keyword">do</span> <span class="token operator">|</span>v<span class="token operator">|</span>
          v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"memsize"</span><span class="token punctuation">]</span> <span class="token operator">=</span> memory
          v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">"numvcpus"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cpus
          v<span class="token punctuation">.</span>vmx<span class="token punctuation">[</span><span class="token string">'virtualHW.version'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>
      <span class="token punctuation">[</span><span class="token string">"parallels"</span><span class="token punctuation">,</span> <span class="token string">"virtualbox"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>h<span class="token operator">|</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provider h <span class="token keyword">do</span> <span class="token operator">|</span>n<span class="token operator">|</span>
          n<span class="token punctuation">.</span>memory <span class="token operator">=</span> memory
          n<span class="token punctuation">.</span>cpus <span class="token operator">=</span> cpus
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>network <span class="token symbol">:private_network</span><span class="token punctuation">,</span> ip<span class="token punctuation">:</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>"</span>

      <span class="token comment" spellcheck="true"># you can override this in synced_folders.yaml</span>
      kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>synced_folder <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"/vagrant"</span><span class="token punctuation">,</span> disabled<span class="token punctuation">:</span> <span class="token keyword">true</span>

      <span class="token keyword">begin</span>
        <span class="token constant">MOUNT_POINTS</span><span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>mount<span class="token operator">|</span>
          mount_options <span class="token operator">=</span> <span class="token string">""</span>
          disabled <span class="token operator">=</span> <span class="token keyword">false</span>
          nfs <span class="token operator">=</span>  <span class="token keyword">true</span>
          <span class="token keyword">if</span> mount<span class="token punctuation">[</span><span class="token string">'mount_options'</span><span class="token punctuation">]</span>
            mount_options <span class="token operator">=</span> mount<span class="token punctuation">[</span><span class="token string">'mount_options'</span><span class="token punctuation">]</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> mount<span class="token punctuation">[</span><span class="token string">'disabled'</span><span class="token punctuation">]</span>
            disabled <span class="token operator">=</span> mount<span class="token punctuation">[</span><span class="token string">'disabled'</span><span class="token punctuation">]</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> mount<span class="token punctuation">[</span><span class="token string">'nfs'</span><span class="token punctuation">]</span>
            nfs <span class="token operator">=</span> mount<span class="token punctuation">[</span><span class="token string">'nfs'</span><span class="token punctuation">]</span>
          <span class="token keyword">end</span>
          <span class="token keyword">if</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span><span class="token builtin">File</span><span class="token punctuation">.</span><span class="token function">expand_path</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>mount<span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span><span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> mount<span class="token punctuation">[</span><span class="token string">'destination'</span><span class="token punctuation">]</span>
              kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>synced_folder <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>mount<span class="token punctuation">[</span><span class="token string">'source'</span><span class="token punctuation">]</span><span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>mount<span class="token punctuation">[</span><span class="token string">'destination'</span><span class="token punctuation">]</span><span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span>
                id<span class="token punctuation">:</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>mount<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span>
                disabled<span class="token punctuation">:</span> disabled<span class="token punctuation">,</span>
                mount_options<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>mount_options<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                nfs<span class="token punctuation">:</span> nfs
            <span class="token keyword">end</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
      <span class="token keyword">rescue</span>
      <span class="token keyword">end</span>

      <span class="token keyword">if</span> <span class="token constant">USE_DOCKERCFG</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span><span class="token constant">DOCKERCFG</span><span class="token punctuation">)</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span><span class="token punctuation">,</span>
         <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>DOCKERCFG<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/home/core/.dockercfg"</span>

        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
          s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"cp /home/core/.dockercfg /root/.dockercfg"</span>
          s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span>
      <span class="token keyword">end</span>

      <span class="token comment" spellcheck="true"># Copy TLS stuff</span>
      <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>CERTS_MASTER_SCRIPT<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/make-certs.sh"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>CERTS_MASTER_CONF<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/openssl.cnf"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> <span class="token symbol">:privileged</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        inline<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">-</span><span class="token constant">EOF</span>
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__MASTER_IP__|<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>openssl<span class="token punctuation">.</span>cnf
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__DNS_DOMAIN__|<span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>openssl<span class="token punctuation">.</span>cnf
        <span class="token constant">EOF</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
          s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"mkdir -p /etc/kubernetes &amp;&amp; cp -R /vagrant/tls/master-kubeconfig.yaml /etc/kubernetes/master-kubeconfig.yaml"</span>
          s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span>
      <span class="token keyword">else</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>CERTS_NODE_SCRIPT<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/make-certs.sh"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>CERTS_NODE_CONF<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/openssl.cnf"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>CERTS_NODE_CONF<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/openssl.cnf"</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
          s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"mkdir -p /etc/kubernetes &amp;&amp; cp -R /vagrant/tls/node-kubeconfig.yaml /etc/kubernetes/node-kubeconfig.yaml"</span>
          s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> <span class="token symbol">:privileged</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        inline<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">-</span><span class="token constant">EOF</span>
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__NODE_IP__|<span class="token interpolation"><span class="token delimiter tag">#{</span>BASE_IP_ADDR<span class="token delimiter tag">}</span></span>.<span class="token interpolation"><span class="token delimiter tag">#{</span>i<span class="token operator">+</span><span class="token number">100</span><span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>openssl<span class="token punctuation">.</span>cnf
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__MASTER_IP__|<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>node<span class="token operator">-</span>kubeconfig<span class="token punctuation">.</span>yaml
        <span class="token constant">EOF</span>
      <span class="token keyword">end</span>

      <span class="token comment" spellcheck="true"># Process Kubernetes manifests, depending on node type</span>
      <span class="token keyword">begin</span>
        <span class="token keyword">if</span> vmName <span class="token operator">==</span> <span class="token string">"master"</span>
          <span class="token keyword">if</span> <span class="token constant">AUTHORIZATION_MODE</span> <span class="token operator">==</span> <span class="token string">"RBAC"</span>
            kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
              s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"mkdir -p /etc/kubernetes/manifests &amp;&amp; find /vagrant/manifests/master* ! -name master-apiserver.yaml -exec cp -t /etc/kubernetes/manifests {} +"</span>
              s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">end</span>
          <span class="token keyword">else</span>
            kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
              s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"mkdir -p /etc/kubernetes/manifests &amp;&amp; cp -R /vagrant/manifests/master* /etc/kubernetes/manifests"</span>
              s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
            <span class="token keyword">end</span>
          <span class="token keyword">end</span>
        <span class="token keyword">else</span>
          kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span> <span class="token keyword">do</span> <span class="token operator">|</span>s<span class="token operator">|</span>
            s<span class="token punctuation">.</span>inline <span class="token operator">=</span> <span class="token string">"mkdir -p /etc/kubernetes/manifests &amp;&amp; cp -R /vagrant/manifests/node* /etc/kubernetes/manifests/"</span>
            s<span class="token punctuation">.</span>privileged <span class="token operator">=</span> <span class="token keyword">true</span>
          <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> run<span class="token punctuation">:</span> <span class="token string">"always"</span><span class="token punctuation">,</span> <span class="token symbol">:privileged</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        inline<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">-</span><span class="token constant">EOF</span>
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s,__RELEASE__,v<span class="token interpolation"><span class="token delimiter tag">#{</span>KUBERNETES_VERSION<span class="token delimiter tag">}</span></span>,g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>manifests<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>yaml
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__MASTER_IP__|<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>manifests<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>yaml
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__DNS_DOMAIN__|<span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>etc<span class="token operator">/</span>kubernetes<span class="token operator">/</span>manifests<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>yaml
        <span class="token constant">EOF</span>
      <span class="token keyword">end</span>

      <span class="token comment" spellcheck="true"># Process vagrantfile</span>
      <span class="token keyword">if</span> <span class="token builtin">File</span><span class="token punctuation">.</span>exist<span class="token operator">?</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:file</span><span class="token punctuation">,</span> <span class="token symbol">:source</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"<span class="token interpolation"><span class="token delimiter tag">#{</span>cfg<span class="token delimiter tag">}</span></span>"</span><span class="token punctuation">,</span> <span class="token symbol">:destination</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"/tmp/vagrantfile-user-data"</span>
        <span class="token keyword">if</span> enable_proxy
          kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> <span class="token symbol">:privileged</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">true</span><span class="token punctuation">,</span>
          inline<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">-</span><span class="token constant">EOF</span>
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__PROXY_LINE__||g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__HTTP_PROXY__|<span class="token interpolation"><span class="token delimiter tag">#{</span>HTTP_PROXY<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__HTTPS_PROXY__|<span class="token interpolation"><span class="token delimiter tag">#{</span>HTTPS_PROXY<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__NO_PROXY__|<span class="token interpolation"><span class="token delimiter tag">#{</span>NO_PROXY<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          <span class="token constant">EOF</span>
        <span class="token keyword">end</span>
        kHost<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>provision <span class="token symbol">:shell</span><span class="token punctuation">,</span> <span class="token symbol">:privileged</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">true</span><span class="token punctuation">,</span>
        inline<span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token operator">&lt;</span><span class="token operator">-</span><span class="token constant">EOF</span>
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"/__PROXY_LINE__/d"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s,__DOCKER_OPTIONS__,<span class="token interpolation"><span class="token delimiter tag">#{</span>DOCKER_OPTIONS<span class="token delimiter tag">}</span></span>,g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s,__RELEASE__,v<span class="token interpolation"><span class="token delimiter tag">#{</span>KUBERNETES_VERSION<span class="token delimiter tag">}</span></span>,g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s,__CHANNEL__,<span class="token interpolation"><span class="token delimiter tag">#{</span>CHANNEL<span class="token delimiter tag">}</span></span>,g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s,__NAME__,<span class="token interpolation"><span class="token delimiter tag">#{</span>hostname<span class="token delimiter tag">}</span></span>,g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__MASTER_IP__|<span class="token interpolation"><span class="token delimiter tag">#{</span>MASTER_IP<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__DNS_DOMAIN__|<span class="token interpolation"><span class="token delimiter tag">#{</span>DNS_DOMAIN<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          sed <span class="token operator">-</span>i<span class="token string">"*"</span> <span class="token string">"s|__ETCD_SEED_CLUSTER__|<span class="token interpolation"><span class="token delimiter tag">#{</span>ETCD_SEED_CLUSTER<span class="token delimiter tag">}</span></span>|g"</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data
          mv <span class="token operator">/</span>tmp<span class="token operator">/</span>vagrantfile<span class="token operator">-</span>user<span class="token operator">-</span>data <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token regex">/coreos-vagrant/</span>
        <span class="token constant">EOF</span>
      <span class="token keyword">end</span>

    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

</pre>
<h6 class="mume-header" id="masteryaml">master.yaml</h6>

<pre class="language-yaml"><span class="token comment" spellcheck="true">#cloud-config</span>

<span class="token punctuation">---</span>
<span class="token key atrule">write-files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/conf.d/nfs
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0644'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      OPTS_RPC_MOUNTD=""</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/bin/wupiao
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0755'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      #!/bin/bash
      # [w]ait [u]ntil [p]ort [i]s [a]ctually [o]pen
      [ -n "$1" ] &amp;&amp; \
        until curl -o /dev/null -sIf http://${1}; do \
          sleep 1 &amp;&amp; echo .;
        done;
      exit $?</span>

<span class="token key atrule">coreos</span><span class="token punctuation">:</span>
  <span class="token key atrule">flannel</span><span class="token punctuation">:</span>
    <span class="token key atrule">interface</span><span class="token punctuation">:</span> $public_ipv4
  <span class="token key atrule">units</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpcbind.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpc<span class="token punctuation">-</span>statd.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>member.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=etcd
        Documentation=https://github.com/coreos/etcd
        [Service]
        Environment='ETCD_IMAGE_TAG=v3.1.8'
        Environment='ETCD_DATA_DIR=/var/lib/etcd'
        Environment='ETCD_USER=etcd'
        Type=notify
        Restart=always
        RestartSec=5s
        LimitNOFILE=40000
        TimeoutStartSec=0
        ExecStart=/usr/lib/coreos/etcd-wrapper --name __NAME__ \
            --listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \
            --advertise-client-urls http://$public_ipv4:2379,http://$public_ipv4:4001 \
            --listen-peer-urls http://$private_ipv4:2380,http://$private_ipv4:7001 \
            --initial-advertise-peer-urls http://$private_ipv4:2380 \
            --initial-cluster __ETCD_SEED_CLUSTER__
        [Install]
        WantedBy=multi-user.target</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flanneld.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>network<span class="token punctuation">-</span>config.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=etcd-member.service
            [Service]
            ExecStartPre=/usr/bin/etcdctl set /coreos.com/network/config '{"Network":"10.244.0.0/16", "Backend": {"Type": "host-gw"}}'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 51<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>mirror.conf
        <span class="token punctuation">-</span> <span class="token key atrule">__PROXY_LINE__name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>proxy.conf
          <span class="token key atrule">__PROXY_LINE__content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            __PROXY_LINE__[Service]
            __PROXY_LINE__EnvironmentFile=/etc/environment</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 40<span class="token punctuation">-</span>flannel.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=flanneld.service
            After=flanneld.service</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>options.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Service]
            Environment='DOCKER_OPTS=--storage-driver=overlay2 __DOCKER_OPTIONS__'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> early<span class="token punctuation">-</span>docker.service
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">__PROXY_LINE__name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>proxy.conf
          <span class="token key atrule">__PROXY_LINE__content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            __PROXY_LINE__[Service]
            __PROXY_LINE__EnvironmentFile=/etc/environment</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>certs.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Generate Kubernetes API Server certificates
        ConditionPathExists=/tmp/make-certs.sh
        Requires=network-online.target
        After=network-online.target
        [Service]
        ExecStartPre=-/usr/sbin/groupadd -r kube-cert
        ExecStartPre=/usr/bin/chmod 755 /tmp/make-certs.sh
        ExecStart=/tmp/make-certs.sh
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>download.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Download Hyperkube Docker image
        Requires=docker.service
        After=docker.service
        ConditionPathExists=!/vagrant/artifacts/hyperkube___RELEASE__.tar
        [Service]
        # ExecStart=/usr/bin/docker pull gcr.io/google_containers/hyperkube-amd64:__RELEASE__
        # ExecStart=/usr/bin/docker save --output /vagrant/artifacts/hyperkube___RELEASE__.tar gcr.io/google_containers/hyperkube-amd64:__RELEASE__
        ExecStart=/usr/bin/docker pull wangwg2/hyperkube-amd64:__RELEASE__
        ExecStart=/usr/bin/docker save --output /vagrant/artifacts/hyperkube___RELEASE__.tar wangwg2/hyperkube-amd64:__RELEASE__
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>import.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Import Hyperkube Docker image
        Requires=docker.service
        After=docker.service
        ConditionPathExists=/vagrant/artifacts/hyperkube___RELEASE__.tar
        [Service]
        ExecStart=/usr/bin/docker load --input /vagrant/artifacts/hyperkube___RELEASE__.tar
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>kubelet.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Kubernetes Kubelet
        Documentation=https://github.com/GoogleCloudPlatform/kubernetes
        Requires=kube-certs.service
        Wants=hyperkube-download.service hyperkube-import.service
        After=kube-certs.service hyperkube-download.service hyperkube-import.service
        [Service]
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        ExecStartPre=-/usr/bin/docker rm -f kubelet
        ExecStart=/usr/bin/docker run \
          --volume=/:/rootfs:ro \
          --volume=/sys:/sys:ro \
          --volume=/etc/kubernetes:/etc/kubernetes:ro \
          --volume=/var/lib/docker/:/var/lib/docker:rw \
          --volume=/var/lib/kubelet/:/var/lib/kubelet:rw \
          --volume=/var/run:/var/run:rw \
          --net=host \
          --pid=host \
          --privileged=true \
          --name=kubelet \
          -d \
          wangwg2/hyperkube-amd64:__RELEASE__ \
            /hyperkube kubelet \
            --address=$private_ipv4 \
            --network-plugin= \
            --pod-infra-container-image=wangwg2/pause-amd64:3.0 \
            --register-schedulable=false \
            --allow-privileged=true \
            --pod-manifest-path=/etc/kubernetes/manifests \
            --hostname-override=$public_ipv4 \
            --cluster_dns=10.100.0.10 \
            --cluster_domain=__DNS_DOMAIN__ \
            --kubeconfig=/etc/kubernetes/master-kubeconfig.yaml
        Restart=on-failure
        RestartSec=10
        WorkingDirectory=/root/
        [Install]
        WantedBy=multi-user.target</span>
  <span class="token key atrule">update</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> __CHANNEL__
    <span class="token key atrule">reboot-strategy</span><span class="token punctuation">:</span> off

</pre>
<h6 class="mume-header" id="nodeyaml">node.yaml</h6>

<pre class="language-yaml"><span class="token comment" spellcheck="true">#cloud-config</span>

<span class="token punctuation">---</span>
<span class="token key atrule">write-files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/conf.d/nfs
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0644'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      OPTS_RPC_MOUNTD=""</span>
  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/bin/wupiao
    <span class="token key atrule">permissions</span><span class="token punctuation">:</span> <span class="token string">'0755'</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      #!/bin/bash
      # [w]ait [u]ntil [p]ort [i]s [a]ctually [o]pen
      [ -n "$1" ] &amp;&amp; \
        until curl -o /dev/null -sIf http://${1}; do \
          sleep 1 &amp;&amp; echo .;
        done;
      exit $?</span>

<span class="token key atrule">coreos</span><span class="token punctuation">:</span>
  <span class="token key atrule">flannel</span><span class="token punctuation">:</span>
    <span class="token key atrule">interface</span><span class="token punctuation">:</span> $public_ipv4
  <span class="token key atrule">units</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpcbind.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rpc<span class="token punctuation">-</span>statd.service
      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>member.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=etcd
        Documentation=https://github.com/coreos/etcd
        [Service]
        Environment='ETCD_IMAGE_TAG=v3.1.8'
        Environment='ETCD_DATA_DIR=/var/lib/etcd'
        Environment='ETCD_USER=etcd'
        Type=notify
        Restart=always
        RestartSec=5s
        LimitNOFILE=40000
        TimeoutStartSec=0
        ExecStart=/usr/lib/coreos/etcd-wrapper --name __NAME__ \
            --proxy on \
            --listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \
            --advertise-client-urls http://$public_ipv4:2379,http://$public_ipv4:4001 \
            --listen-peer-urls http://$private_ipv4:2380,http://$private_ipv4:7001 \
            --initial-advertise-peer-urls http://$private_ipv4:2380 \
            --initial-cluster __ETCD_SEED_CLUSTER__
        [Install]
        WantedBy=multi-user.target</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flanneld.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>network<span class="token punctuation">-</span>config.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=etcd-member.service
            [Service]
            ExecStartPre=/usr/bin/etcdctl set /coreos.com/network/config '{"Network":"10.244.0.0/16", "Backend": {"Type": "host-gw"}}'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 51<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>mirror.conf
        <span class="token punctuation">-</span> <span class="token key atrule">__PROXY_LINE__name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>proxy.conf
          <span class="token key atrule">__PROXY_LINE__content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            __PROXY_LINE__[Service]
            __PROXY_LINE__EnvironmentFile=/etc/environment</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 40<span class="token punctuation">-</span>flannel.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Unit]
            Requires=flanneld.service
            After=flanneld.service</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 50<span class="token punctuation">-</span>docker<span class="token punctuation">-</span>options.conf
          <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            [Service]
            Environment='DOCKER_OPTS=__DOCKER_OPTIONS__'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> early<span class="token punctuation">-</span>docker.service
      <span class="token key atrule">drop-ins</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">__PROXY_LINE__name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>proxy.conf
          <span class="token key atrule">__PROXY_LINE__content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            __PROXY_LINE__[Service]
            __PROXY_LINE__EnvironmentFile=/etc/environment</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>certs.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Generate Kubernetes Node certificates
        ConditionPathExists=/tmp/make-certs.sh
        Requires=network-online.target
        After=network-online.target
        [Service]
        ExecStartPre=-/usr/sbin/groupadd -r kube-cert
        ExecStartPre=/usr/bin/chmod 755 /tmp/make-certs.sh
        ExecStart=/tmp/make-certs.sh
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hyperkube<span class="token punctuation">-</span>import.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Import Hyperkube Docker image
        Requires=docker.service
        After=docker.service
        ConditionPathExists=/vagrant/artifacts/hyperkube___RELEASE__.tar
        [Service]
        ExecStart=/usr/bin/docker load --input /vagrant/artifacts/hyperkube___RELEASE__.tar
        Type=oneshot
        RemainAfterExit=true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>kubelet.service
      <span class="token key atrule">command</span><span class="token punctuation">:</span> start
      <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        [Unit]
        Description=Kubernetes Kubelet
        Documentation=https://github.com/GoogleCloudPlatform/kubernetes
        Requires=hyperkube-import.service kube-certs.service
        After=hyperkube-import.service kube-certs.service
        [Service]
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        ExecStartPre=-/usr/bin/docker rm -f kubelet
        ExecStart=/usr/bin/docker run \
          --volume=/:/rootfs:ro \
          --volume=/sys:/sys:ro \
          --volume=/etc/kubernetes:/etc/kubernetes:ro \
          --volume=/var/lib/docker/:/var/lib/docker:rw \
          --volume=/var/lib/kubelet/:/var/lib/kubelet:shared \
          --volume=/var/run:/var/run:rw \
          --net=host \
          --pid=host \
          --privileged=true \
          --name=kubelet \
          -d \
          wangwg2/hyperkube-amd64:__RELEASE__ \
            /hyperkube kubelet \
            --containerized \
            --address=$private_ipv4 \
            --network-plugin= \
            --allow-privileged=true \
            --pod-manifest-path=/etc/kubernetes/manifests \
            --hostname-override=$public_ipv4 \
            --cluster_dns=10.100.0.10 \
            --cluster_domain=__DNS_DOMAIN__ \
            --kubeconfig=/etc/kubernetes/node-kubeconfig.yaml \
            --tls-cert-file=/etc/kubernetes/ssl/node.pem \
            --tls-private-key-file=/etc/kubernetes/ssl/node-key.pem
        Restart=on-failure
        RestartSec=10
        WorkingDirectory=/root/
        [Install]
        WantedBy=multi-user.target</span>
  <span class="token key atrule">update</span><span class="token punctuation">:</span>
    <span class="token key atrule">group</span><span class="token punctuation">:</span> __CHANNEL__
    <span class="token key atrule">reboot-strategy</span><span class="token punctuation">:</span> off

</pre>
<h6 class="mume-header" id="setuptmpl">setup.tmpl</h6>

<pre class="language-bash {as=&quot;bash&quot;}"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">set</span> -e

PLATFORM<span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s <span class="token operator">|</span> <span class="token function">tr</span> '<span class="token punctuation">[</span>:upper:<span class="token punctuation">]</span>' '<span class="token punctuation">[</span>:lower:<span class="token punctuation">]</span>'<span class="token variable">)</span></span>"</span>
KUBERNETES_VERSION<span class="token operator">=</span>__KUBERNETES_VERSION__
<span class="token comment" spellcheck="true"># KUB_URL="https://storage.googleapis.com/kubernetes-release/release/v${KUBERNETES_VERSION}/bin/${PLATFORM}/amd64/kubectl"</span>
KUB_URL<span class="token operator">=</span><span class="token string">"http://192.168.99.23:8080/kubectl"</span>

scream <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cat</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"<span class="token variable">$@</span>"</span> 1<span class="token operator">></span><span class="token operator">&amp;</span>2
    <span class="token keyword">exit</span> 1
<span class="token punctuation">}</span>

<span class="token keyword">case</span> <span class="token string">"<span class="token variable">$PLATFORM</span>"</span> <span class="token keyword">in</span>
  darwin<span class="token operator">|</span>linux<span class="token punctuation">)</span>
    targetDir<span class="token operator">=</span><span class="token string">"/usr/local/bin"</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -r /etc/os-release <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">.</span> /etc/os-release
      <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$ID</span> <span class="token operator">=</span> coreos <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        targetDir<span class="token operator">=</span><span class="token string">"/opt/bin"</span>
        unlink <span class="token variable">$HOME</span>/.bash_profile
        <span class="token function">cp</span> /usr/share/skel/.bash_profile <span class="token variable">$HOME</span>/.bash_profile
        <span class="token function">chmod</span> 775 <span class="token variable">$HOME</span>/.bash_profile
      <span class="token keyword">fi</span>
    <span class="token keyword">fi</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
  *<span class="token punctuation">)</span>
    scream <span class="token string">"Unknown or unsupported platform: <span class="token variable">${PLATFORM}</span>"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
esac

<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> -eq 1 <span class="token operator">&amp;&amp;</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">==</span> <span class="token string">"install"</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
  doinstall<span class="token operator">=</span><span class="token string">"true"</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> -x <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    installedversion<span class="token operator">=</span>`<span class="token variable">${targetDir}</span>/kubectl version <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">":"</span> <span class="token string">'{print <span class="token variable">$5</span>}'</span> <span class="token operator">|</span> <span class="token function">head</span> -n1 <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">","</span> <span class="token punctuation">{</span><span class="token string">'print <span class="token variable">$1</span>'</span><span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">"\""</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">"v"</span>`
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$installedversion</span>"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">${KUBERNETES_VERSION}</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      <span class="token keyword">echo</span> <span class="token string">"kubectl already installed in version '<span class="token variable">$installedversion</span>'. Skipping install."</span>
      doinstall<span class="token operator">=</span><span class="token string">"false"</span>
    <span class="token keyword">else</span>
      <span class="token keyword">echo</span> <span class="token string">"kubectl installed in version '<span class="token variable">$installedversion</span>' instead of '<span class="token variable">${KUBERNETES_VERSION}</span>'. Reinstalling."</span>
    <span class="token keyword">fi</span>
  <span class="token keyword">fi</span>

  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$doinstall</span>"</span> <span class="token operator">==</span> <span class="token string">"true"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> 
    <span class="token keyword">echo</span> <span class="token string">"Downloading and installing <span class="token variable">${PLATFORM}</span> version of 'kubectl' v<span class="token variable">${KUBERNETES_VERSION}</span> into <span class="token variable">${targetDir}</span>. This may take a couple minutes, depending on your internet speed.."</span>
    <span class="token punctuation">[</span> -d <span class="token variable">${targetDir}</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">sudo</span> <span class="token function">mkdir</span> -p <span class="token variable">${targetDir}</span>
    <span class="token function">sudo</span> -E curl -s -k -L -o <span class="token variable">${targetDir}</span>/kubectl <span class="token string">"<span class="token variable">${KUB_URL}</span>"</span>
    <span class="token punctuation">[</span> -x <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token function">sudo</span> <span class="token function">chmod</span> +x <span class="token variable">${targetDir}</span>/kubectl
  <span class="token keyword">fi</span>

  <span class="token comment" spellcheck="true"># use sed to replace current values, if any; create profile file if not exists</span>
  <span class="token function">touch</span> -a <span class="token variable">$HOME</span>/.bash_profile
  <span class="token keyword">echo</span> <span class="token string">"Configuring environment.."</span>
  __PROXY_LINE__if <span class="token operator">!</span> <span class="token function">grep</span> -q <span class="token string">'export NO_PROXY'</span> <span class="token variable">$HOME</span>/.bash_profile <span class="token punctuation">;</span> <span class="token keyword">then</span>
  __PROXY_LINE__  <span class="token keyword">echo</span> <span class="token string">"export NO_PROXY=__NO_PROXY__"</span> <span class="token operator">>></span> <span class="token variable">$HOME</span>/.bash_profile
  __PROXY_LINE__  <span class="token keyword">echo</span> <span class="token string">"export no_proxy=__NO_PROXY__"</span> <span class="token operator">>></span> <span class="token variable">$HOME</span>/.bash_profile
  __PROXY_LINE__else
  __PROXY_LINE__  <span class="token function">sed</span> -i<span class="token string">'*'</span> <span class="token string">'s|.*export NO_PROXY.*|export NO_PROXY=__NO_PROXY__|'</span> <span class="token variable">$HOME</span>/.bash_profile
  __PROXY_LINE__  <span class="token function">sed</span> -i<span class="token string">'*'</span> <span class="token string">'s|.*export no_proxy.*|export no_proxy=__NO_PROXY__|'</span> <span class="token variable">$HOME</span>/.bash_profile
  __PROXY_LINE__fi
  __PROXY_LINE__export NO_PROXY<span class="token operator">=</span>__NO_PROXY__
  __PROXY_LINE__export no_proxy<span class="token operator">=</span>__NO_PROXY__
<span class="token keyword">elif</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> -eq 1 <span class="token operator">&amp;&amp;</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">==</span> <span class="token string">"uninstall"</span>  <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token keyword">echo</span> <span class="token string">"Removing 'kubectl' v<span class="token variable">${KUBERNETES_VERSION}</span>.."</span>
  <span class="token punctuation">[</span> -f <span class="token variable">${targetDir}</span>/kubectl <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">rm</span> -f <span class="token variable">${targetDir}</span>/kubectl
<span class="token keyword">else</span>
  <span class="token keyword">echo</span> <span class="token string">"Usage: ./setup (install|uninstall)"</span>
<span class="token keyword">fi</span>

</pre>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#kubernetes-vagrant-coreos-cluster">kubernetes-vagrant-coreos-cluster</a>
<ul>
<li><a href="#%E4%BF%AE%E6%94%B9%E8%AF%B4%E6%98%8E">修改说明</a><br>
* <a href="#update-log">Update Log</a><br>
* <a href="#vagrant-%E8%99%9A%E6%9C%BA%E8%AE%BE%E7%BD%AE">Vagrant 虚机设置</a><br>
* <a href="#window-sh-%E9%87%8D%E5%AE%9A%E5%90%91%E9%97%AE%E9%A2%98">Window sh 重定向问题</a><br>
* <a href="#kubectl-%E4%B8%8B%E8%BD%BD%E6%85%A2">kubectl 下载慢</a><br>
* <a href="#docker-registry">Docker Registry</a><br>
* <a href="#docker_options">DOCKER_OPTIONS</a><br>
* <a href="#masteryml">master.yml</a></li>
<li><a href="#vagrantfile-%E8%A7%A3%E6%9E%90">Vagrantfile 解析</a><br>
* <a href="#vagrantfile-1">Vagrantfile (1)</a><br>
* <a href="#vagrantfile-2">Vagrantfile (2)</a><br>
* <a href="#vagrantfile-3">Vagrantfile (3)</a><br>
* <a href="#%E5%88%86%E9%98%B6%E6%AE%B5%E6%96%87%E4%BB%B6%E6%A3%80%E6%9F%A5">分阶段文件检查</a><br>
* <a href="#vagrantfile-user-data">vagrantfile-user-data</a><br>
* <a href="#after-up-resume">after [:up, :resume]</a></li>
<li><a href="#coreos-file-list">CoreOS File List</a><br>
* <a href="#coredns-deploymentyaml">coredns-deployment.yaml</a><br>
* <a href="#kubectlsetup">kubectlsetup</a><br>
* <a href="#master-kubeconfigyaml">master-kubeconfig.yaml</a><br>
* <a href="#master-apiserver-rbacyaml">master-apiserver-rbac.yaml</a><br>
* <a href="#master-apiserveryaml">master-apiserver.yaml</a><br>
* <a href="#master-controller-manageryaml">master-controller-manager.yaml</a><br>
* <a href="#master-proxyyaml">master-proxy.yaml</a><br>
* <a href="#master-scheduleryaml">master-scheduler.yaml</a><br>
* <a href="#vagrantfile-user-data-1">vagrantfile-user-data</a><br>
* <a href="#make-certssh">make-certs.sh</a><br>
* <a href="#opensslcnf">openssl.cnf</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95%E5%AE%BF%E4%B8%BB%E6%9C%BA">文件清单（宿主机）</a><br>
* <a href="#vagrantfile">Vagrantfile</a><br>
* <a href="#masteryaml">master.yaml</a><br>
* <a href="#nodeyaml">node.yaml</a><br>
* <a href="#setuptmpl">setup.tmpl</a></li>
</ul>
</li>
</ul>
</div>
      <a id="sidebar-toc-btn">≡</a>
    </body>
    
    
    
    
    
    <script>
(function bindTaskListEvent() {
  var taskListItemCheckboxes = document.body.getElementsByClassName('task-list-item-checkbox')
  for (var i = 0; i < taskListItemCheckboxes.length; i++) {
    var checkbox = taskListItemCheckboxes[i]
    var li = checkbox.parentElement
    if (li.tagName !== 'LI') li = li.parentElement
    if (li.tagName === 'LI') {
      li.classList.add('task-list-item')
    }
  }
}())    
</script>
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  </html>